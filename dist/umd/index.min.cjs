/**
 * maptalks通用工具封装 => jUtilsMaptalks
 * @update 2024-10-18 16:24:16
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("lodash-es"),require("axios"),require("@bestime/utils_base"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","maptalks","lodash-es","axios","@bestime/utils_base","lodash"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jUtilsMaptalks={},e.maptalks,e.lodashEs,e.axios,e.utils_base,e.lodash)}(this,function(e,n,u,t,c,o){"use strict";function l(e,t,i,o,r,n,a){try{var s=e[n](a),l=s.value}catch(u){return void i(u)}s.done?t(l):Promise.resolve(l).then(o,r)}function r(s){return function(){var e=this,a=arguments;return new Promise(function(t,i){var o=s.apply(e,a);function r(e){l(o,t,i,r,n,"next",e)}function n(e){l(o,t,i,r,n,"throw",e)}r(undefined)})}}function a(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,i(e,t)}function i(e,t){return(i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function i(e,t){return e.__proto__=t,e})(e,t)}function s(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var h,f=function(o){function e(e,t,i){e=o.call(this,e,i)||this;return e._config=void 0,e._config=t,e}return a(e,o),e.prototype.getConfig=function(){return this._config},e}(n.Layer),d=function(e){function t(){return e.apply(this,arguments)||this}a(t,e);var i=t.prototype;return i.checkResources=function(){return[]},i.draw=function(){this._drawData(),this.completeRender()},i.drawOnInteracting=function(){this.draw()},i._drawData=function(){var e=this.layer.getConfig(),t=this.getMap().getSize(),i=(this.prepareCanvas(),this.context);i.fillStyle=e.backgroundColor,i.fillRect(0,0,t.width,t.height),i.lineWidth=e.borderWidth,i.strokeStyle=e.borderColor,i.strokeRect(0,0,t.width,t.height)},t}(n.renderer.CanvasRenderer);function y(e){return t({baseURL:"",url:h+"/readonly-utils_maptalks-static"+e})}function _(e,i){var o=[],r=[];return null!=e&&null!=(e=e.features)&&e.forEach(function(e){var t;"MultiPolygon"===e.geometry.type&&(t=new n.MultiPolygon(e.geometry.coordinates,{properties:e.properties,symbol:{polygonFill:i.backgroundColor,lineWidth:i.lineWidth,lineColor:i.lineColor}}),c.isArray(e.properties.center)&&(e=new n.Marker(e.properties.center,{symbol:{textFaceName:"Microsoft YaHei",textName:e.properties.name,textWeight:"normal",textStyle:"normal",textSize:i.fontSize,textFont:null,textFill:i.fontColor,textHaloFill:i.fontHaloFill,textHaloRadius:i.fontHaloRadius,textDx:0,textDy:0,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textAlign:"center"}}),r.push(e)),o.push(t))}),{polygons:o,markers:r}}f.registerRenderer("canvas",d);d=function(){function e(e,t,i){this._layer_01=void 0,this._layer_02=void 0,this._config=void 0,this._config={backgroundLayerStyle:u.merge({backgroundColor:"rgba(0,0,0,0.1)",lineColor:"#1a504e",lineWidth:1,fontSize:12,fontColor:"#66a1a3",fontHaloFill:"black",fontHaloRadius:1},i.backgroundLayerStyle),frontLayerStyle:u.merge({backgroundColor:"#013733",lineColor:"#1a504e",lineWidth:1,fontColor:"white",fontSize:12,fontHaloFill:"black",fontHaloRadius:1},i.frontLayerStyle)};i=u.merge({zIndex:2,forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0},t),t=u.cloneDeep(i);--t.zIndex,this._layer_01=new n.VectorLayer(e+"_station",i),this._layer_02=new n.VectorLayer(e+"_background",t)}var t=e.prototype;return t.setAreaCode=function(){var t=r(function*(e){var t=this;yield y("/geos/"+e+"_full.json").then(function(e){e=e.data,e=_(e,t._config.frontLayerStyle);t._layer_01.clear(),t._layer_01.addGeometry(e.polygons),t._layer_01.addGeometry(e.markers)})});return function(e){return t.apply(this,arguments)}}(),t.setBackgroundAreaCode=function(){var t=r(function*(e){var t=this;yield y("/geos/"+e+"_full.json").then(function(e){e=e.data,e=_(e,t._config.backgroundLayerStyle);t._layer_02.clear(),t._layer_02.addGeometry(e.polygons),t._layer_02.addGeometry(e.markers)})});return function(e){return t.apply(this,arguments)}}(),t.addTo=function(e){this._layer_01.addTo(e),this._layer_02.addTo(e)},t.clear=function(){this._layer_01.clear(),this._layer_02.clear()},t.dispose=function(){this._layer_01.clear().remove(),this._layer_02.clear().remove()},e}();function p(e,t){e._cache||(e._cache={textDx:c._Number(e.textDx),textDy:c._Number(e.textDy),textOpacity:c._Number(e.textOpacity),textSize:c._Number(e.textSize)}),c.isNull(t.textOpacity)?e.textOpacity=e._cache.textOpacity:e.textOpacity=t.textOpacity,c.isNull(t.textSize)?e.textSize=e._cache.textSize:e.textSize=t.textSize,c.isNull(t.textOffset)?(e.textDx=e._cache.textDx,e.textDy=e._cache.textDy):(e.textDx=e._cache.textDx+t.textOffset[0],e.textDy=e._cache.textDy+t.textOffset[1])}function m(e,t){e._cache||(e._cache={markerWidth:c._Number(e.markerWidth),markerHeight:c._Number(e.markerHeight),markerOpacity:c._Number(e.markerOpacity)}),c.isNull(t.iconSize)?(e.markerWidth=e._cache.markerWidth,e.markerHeight=e._cache.markerHeight):(e.markerWidth=t.iconSize,e.markerHeight=t.iconSize),c.isNull(t.iconOpacity)?e.markerOpacity=e._cache.markerOpacity:e.markerOpacity=t.iconOpacity}function g(e,t,i){var o,t=e[t],e=!1;return c.isNull(null==t?void 0:t.length)?e=!1:(e=!0,o=t.find(function(e){return i>e.zoom})),{hasRule:e,style:o}}var b=function(r){function e(e,t,i,o){e=r.call(this,e,t,i)||this;return e._offsetStyle=void 0,e._showIds=[],e._config=void 0,e._timer01=void 0,e._config=o,e._onZoomed=e._onZoomed.bind(s(e)),e}a(e,r);var t=e.prototype;return t._debHandlerResize=function(){var e=this;clearTimeout(this._timer01),this._timer01=setTimeout(function(){e._onReszie()},100)},t._onZoomed=function(){this._debHandlerResize()},t._onReszie=function(){var a,s,l=this;this._offsetStyle&&(a=this.getMap().getZoom(),s=[],this.forEach(function(e){var t=null==(t=e.properties)?void 0:t.offsetMemberId,i=null==(i=e.properties)?void 0:i.offsetMemberGroupId;if(!c.isNull(t)){var o=g(l._offsetStyle.memember,t,a),r=g(l._offsetStyle.group,i,a);if((!r.hasRule||r.hasRule&&r.style)&&!s.includes(i)&&s.push(i),!l._showIds.includes(t))return e.hide();e.show();var n=u.cloneDeep(o);return r.hasRule&&(n.hasRule=r.hasRule,!r.style||o.hasRule&&!o.style?n.style=void 0:n.style=u.merge({},r.style,o.style)),n.hasRule?(i=e.getSymbol(),n.style&&n.style?(i&&(c.isArray(i)?i.forEach(function(e){e.textSize?p(e,n.style):e.markerFile&&m(e,n.style)}):i.textSize?p(i,n.style):i.markerFile&&m(i,n.style),e.updateSymbol(i)),void e.show()):e.hide()):void 0}}),this._config.onGroupVisibleChange(s))},t.setActiveMememberIds=function(e){this._showIds=e,this._debHandlerResize()},t.setOffsetStyle=function(e){if(e)for(var t in e.memember)e.memember[t].sort(function(e,t){return t.zoom-e.zoom});return this._offsetStyle=e,this._debHandlerResize(),this},t.addGeometry=function(e,t){r.prototype.addGeometry.call(this,e,t),this._debHandlerResize()},t.onAdd=function(){r.prototype.onAdd.call(this),this._debHandlerResize()},t.addTo=function(e){return r.prototype.addTo.call(this,e),e.on("zoomend",this._onZoomed),this},t.clear=function(){return clearTimeout(this._timer01),r.prototype.clear.call(this),this},t.remove=function(){var e;return clearTimeout(this._timer01),r.prototype.remove.call(this),null!=(e=this.getMap())&&e.off("zoomend",this._onZoomed),this},e}(n.VectorLayer),x=function(i){function e(e,t){e=i.call(this,e,t)||this;return e._testCount=0,e._heartbeatConfig={duration:200,isRestore:!0,isMouseIn:!1,originZindx:0,targetZindex:0,looping:!1,originStyle:{},targetStyle:{}},e._player=void 0,t.symbol&&(e._heartbeatConfig.originStyle=o.cloneDeep(t.symbol)),e._heartbeatConfig.duration=t.duration,e._heartbeatConfig.originZindx=c.defualtFormatter(0,t.zIndex),e._heartbeatConfig.targetZindex=1+e._heartbeatConfig.originZindx,e._heartbeatConfig.targetStyle={lineWidth:t.targetWidth},e._onMouseenter=e._onMouseenter.bind(s(e)),e._onMouseout=e._onMouseout.bind(s(e)),e.on("mouseenter",e._onMouseenter),e.on("mouseout",e._onMouseout),e}a(e,i);var t=e.prototype;return t.updateSymbol=function(e){return i.prototype.updateSymbol.call(this,e),this},t._onMouseenter=function(){this._heartbeatConfig.isMouseIn=!0,this.playActive()},t._onMouseout=function(){this._heartbeatConfig.isMouseIn=!1,this.playRestore(!0)},t.play=function(){var e=this.getSymbol();return c.isNull(e._targetWidth)&&(e._targetWidth=e.lineWidth),this.updateSymbol(e),this},t.playLoop=function(){var t,i=this;this._heartbeatConfig.looping=!0,this._clearPlayer(),(t=function(){var e=r(function*(){!i._heartbeatConfig.looping&&i._heartbeatConfig.isRestore||(i._heartbeatConfig.isRestore?(yield i.playActive(),i._heartbeatConfig.isRestore=!1):(yield i.playRestore(),i._heartbeatConfig.isRestore=!0),t())});return function t(){return e.apply(this,arguments)}}())()},t.playActive=function(){var e=r(function*(){var e=this;return this._clearPlayer(),this.setZIndex(this._heartbeatConfig.targetZindex),new Promise(function(t){e._player=e.animate({symbol:e._heartbeatConfig.targetStyle},{duration:e._heartbeatConfig.duration},function(e){"finished"===e.state.playState&&t(!0)})})});return function(){return e.apply(this,arguments)}}(),t.playRestore=function(){var t=r(function*(e){var i=this;if(!e||!this._heartbeatConfig.looping)return this._clearPlayer(),new Promise(function(t){i._player=i.animate({symbol:i._heartbeatConfig.originStyle},{duration:i._heartbeatConfig.duration},function(e){"finished"===e.state.playState&&(i._heartbeatConfig.looping||i.setZIndex(i._heartbeatConfig.originZindx),t(!0))})});this.playLoop()});return function(e){return t.apply(this,arguments)}}(),t.remove=function(){var e;return this.stopLoop(),null!=(e=this._player)&&e.finish(),this._clearPlayer(),this.off("mouseenter",this._onMouseenter),this.off("mouseout",this._onMouseout),null!=this&&null!=(e=this._clearAllListeners)&&e.call(this),i.prototype.remove.call(this),this},t._clearPlayer=function(){var e;null!=(e=this._player)&&e.pause(),this._animPlayer=void 0},t.stopLoop=function(){return this._heartbeatConfig.looping=!1,this},e}(n.LineString);x.registerJSONType("HeartbeatLineString"),e.BorderLayer=f,e.CityBoundry=d,e.HeartbeatLineString=x,e.OffsetLayer=b,e["default"]=function(e){h=e},Object.defineProperty(e,"__esModule",{value:!0})});
