/**
 * maptalks通用工具封装 => jUtilsMaptalks
 * @update 2024-10-16 18:19:21
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("lodash-es"),require("axios"),require("@bestime/utils_base"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","maptalks","lodash-es","axios","@bestime/utils_base","lodash"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jUtilsMaptalks={},e.maptalks,e.lodashEs,e.axios,e.utils_base)}(this,function(e,i,l,t,u){"use strict";function c(e,t,r,i,o,n,s){try{var a=e[n](s),c=a.value}catch(l){return void r(l)}a.done?t(c):Promise.resolve(c).then(i,o)}function o(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,r(e,t)}function r(e,t){return(r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function r(e,t){return e.__proto__=t,e})(e,t)}var n,s=function(i){function e(e,t,r){e=i.call(this,e,r)||this;return e._config=void 0,e._config=t,e}return o(e,i),e.prototype.getConfig=function(){return this._config},e}(i.Layer),a=function(e){function t(){return e.apply(this,arguments)||this}o(t,e);var r=t.prototype;return r.checkResources=function(){return[]},r.draw=function(){this._drawData(),this.completeRender()},r.drawOnInteracting=function(){this.draw()},r._drawData=function(){var e=this.layer.getConfig(),t=this.getMap().getSize(),r=(this.prepareCanvas(),this.context);r.fillStyle=e.backgroundColor,r.fillRect(0,0,t.width,t.height),r.lineWidth=e.borderWidth,r.strokeStyle=e.borderColor,r.strokeRect(0,0,t.width,t.height)},t}(i.renderer.CanvasRenderer);function f(e){return t({baseURL:"",url:n+"/readonly-utils_maptalks-static"+e})}s.registerRenderer("canvas",a);a=function(){function e(e,t){this._layer=void 0;t=l.merge({zIndex:1,forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0},t);this._layer=new i.VectorLayer(e,t)}var t=e.prototype;return t.setAreaCode=function(){a=function*(e){var r=this;yield f("/geos/"+e+"_full.json").then(function(e){var t,e=e["data"],e=(t=[],null!=(e=e)&&null!=(e=e.features)&&e.forEach(function(e){"MultiPolygon"===e.geometry.type&&(e=new i.MultiPolygon(e.geometry.coordinates,{properties:e.properties,symbol:{polygonFill:"transparent",lineWidth:1,lineColor:"#ddd"}}),t.push(e))}),t);r._layer.clear(),r._layer.addGeometry(e)})};var a,t=function(){var e=this,s=arguments;return new Promise(function(t,r){var i=a.apply(e,s);function o(e){c(i,t,r,o,n,"next",e)}function n(e){c(i,t,r,o,n,"throw",e)}o(undefined)})};return function(e){return t.apply(this,arguments)}}(),t.addTo=function(e){this._layer.addTo(e)},t.clear=function(){this._layer.clear()},t.dispose=function(){this._layer.clear().remove()},e}();function h(e,t){e._cache||(e._cache={textDx:u._Number(e.textDx),textDy:u._Number(e.textDy),textOpacity:u._Number(e.textOpacity),textSize:u._Number(e.textSize)}),u.isNull(t.textOpacity)?e.textOpacity=e._cache.textOpacity:e.textOpacity=t.textOpacity,u.isNull(t.textSize)?e.textSize=e._cache.textSize:e.textSize=t.textSize,u.isNull(t.textOffset)?(e.textDx=e._cache.textDx,e.textDy=e._cache.textDy):(e.textDx=e._cache.textDx+t.textOffset[0],e.textDy=e._cache.textDy+t.textOffset[1])}function d(e,t){e._cache||(e._cache={markerWidth:u._Number(e.markerWidth),markerHeight:u._Number(e.markerHeight),markerOpacity:u._Number(e.markerOpacity)}),u.isNull(t.iconSize)?(e.markerWidth=e._cache.markerWidth,e.markerHeight=e._cache.markerHeight):(e.markerWidth=t.iconSize,e.markerHeight=t.iconSize),u.isNull(t.iconOpacity)?e.markerOpacity=e._cache.markerOpacity:e.markerOpacity=t.iconOpacity,console.log("图标",e,e._cache.iconSize,t.iconSize)}function y(e,t,r){var i,t=e[t],e=!1;return u.isNull(null==t?void 0:t.length)?e=!1:(e=!0,i=t.find(function(e){return r>e.zoom})),{hasRule:e,style:i}}var p=function(i){function e(e,t,r){e=i.call(this,e,t,r)||this;return e._offsetStyle=void 0,e._showIds=[],e._onResize=e._onResize.bind(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)),e}o(e,i);var t=e.prototype;return t._onResize=function(){var a,c=this;this._offsetStyle&&(a=this.getMap().getZoom(),this.forEach(function(e){var t=null==(t=e.properties)?void 0:t.offsetMemberId,r=null==(r=e.properties)?void 0:r.offsetMemberGroupId;if(!u.isNull(t)){if(!c._showIds.includes(t))return console.log("直接隐藏"),e.hide();console.log("++++++++++++"),e.show();var i,o=y(c._offsetStyle.memember,t,a),n=y(c._offsetStyle.group,r,a),s=l.cloneDeep(o);return n.hasRule&&(s.hasRule=n.hasRule,n.style?s.style=l.merge({},n.style,o.style):s.style=void 0),s.hasRule?(i=e.getSymbol(),console.log("找到配置",r,t,n,o,s),s.style&&s.style?(i&&(u.isArray(i)?i.forEach(function(e){e.textSize?h(e,s.style):e.markerFile&&d(e,s.style)}):i.textSize?h(i,s.style):i.markerFile&&d(i,s.style),e.updateSymbol(i)),void e.show()):e.hide()):void 0}}))},t.setActiveMememberIds=function(e){this._showIds=e,console.log("显示的成员",e),this._onResize()},t.setOffsetStyle=function(e){for(var t in e.memember)e.memember[t].sort(function(e,t){return t.zoom-e.zoom});return this._offsetStyle=e,this._onResize(),this},t.addGeometry=function(e,t){i.prototype.addGeometry.call(this,e,t),console.log("被添加了元素"),this._onResize()},t.onAdd=function(){i.prototype.onAdd.call(this),this._onResize()},t.addTo=function(e){return i.prototype.addTo.call(this,e),e.on("zoomend",this._onResize),this},t.clear=function(){return i.prototype.clear.call(this),this},t.remove=function(){var e;return i.prototype.remove.call(this),null!=(e=this.getMap())&&e.off("zoomend",this._onResize),this},e}(i.VectorLayer),m=function(r){function e(e,t){return r.call(this,e,t)||this}return o(e,r),e}(i.LineString);m.registerJSONType("HeartbeatLineString"),e.BorderLayer=s,e.CityBoundry=a,e.HeartbeatLineString=m,e.OffsetLayer=p,e["default"]=function(e){n=e},Object.defineProperty(e,"__esModule",{value:!0})});
