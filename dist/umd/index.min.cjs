/**
 * maptalks通用工具封装 => jUtilsMaptalks
 * @update 2024-10-19 00:43:28
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("lodash-es"),require("axios"),require("@bestime/utils_base"),require("lodash")):"function"==typeof define&&define.amd?define(["exports","maptalks","lodash-es","axios","@bestime/utils_base","lodash"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).jUtilsMaptalks={},e.maptalks,e.lodashEs,e.axios,e.utils_base,e.lodash)}(this,function(e,r,c,t,f,n){"use strict";function s(e,t,i,n,o,r,l){try{var a=e[r](l),s=a.value}catch(u){return void i(u)}a.done?t(s):Promise.resolve(s).then(n,o)}function o(a){return function(){var e=this,l=arguments;return new Promise(function(t,i){var n=a.apply(e,l);function o(e){s(n,t,i,o,r,"next",e)}function r(e){s(n,t,i,o,r,"throw",e)}o(undefined)})}}function l(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,i(e,t)}function i(e,t){return(i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function i(e,t){return e.__proto__=t,e})(e,t)}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var u,d=function(n){function e(e,t,i){e=n.call(this,e,i)||this;return e._config=void 0,e._config=t,e}return l(e,n),e.prototype.getConfig=function(){return this._config},e}(r.Layer),h=function(e){function t(){return e.apply(this,arguments)||this}l(t,e);var i=t.prototype;return i.checkResources=function(){return[]},i.draw=function(){this._drawData(),this.completeRender()},i.drawOnInteracting=function(){this.draw()},i._drawData=function(){var e=this.layer.getConfig(),t=this.getMap().getSize(),i=(this.prepareCanvas(),this.context);i.fillStyle=e.backgroundColor,i.fillRect(0,0,t.width,t.height),i.lineWidth=e.borderWidth,i.strokeStyle=e.borderColor,i.strokeRect(0,0,t.width,t.height)},t}(r.renderer.CanvasRenderer);function y(e){return t({baseURL:"",url:u+"/readonly-utils_maptalks-static"+e})}function p(e,i){var n=[],o=[];return null!=e&&null!=(e=e.features)&&e.forEach(function(e){var t;"MultiPolygon"===e.geometry.type&&(t=new r.MultiPolygon(e.geometry.coordinates,{properties:e.properties,symbol:{polygonFill:i.backgroundColor,lineWidth:i.lineWidth,lineColor:i.lineColor}}),f.isArray(e.properties.center)&&(e=new r.Marker(e.properties.center,{symbol:{textFaceName:"Microsoft YaHei",textName:e.properties.name,textWeight:"normal",textStyle:"normal",textSize:i.fontSize,textFont:null,textFill:i.fontColor,textHaloFill:i.fontHaloFill,textHaloRadius:i.fontHaloRadius,textDx:0,textDy:0,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textAlign:"center"}}),o.push(e)),n.push(t))}),{polygons:n,markers:o}}d.registerRenderer("canvas",h);h=function(){function e(e,t,i){this._layer_01=void 0,this._layer_02=void 0,this._config=void 0,this._config={backgroundLayerStyle:c.merge({backgroundColor:"rgba(0,0,0,0.1)",lineColor:"#1a504e",lineWidth:1,fontSize:12,fontColor:"#66a1a3",fontHaloFill:"black",fontHaloRadius:1},i.backgroundLayerStyle),frontLayerStyle:c.merge({backgroundColor:"#013733",lineColor:"#1a504e",lineWidth:1,fontColor:"white",fontSize:12,fontHaloFill:"black",fontHaloRadius:1},i.frontLayerStyle)};i=c.merge({zIndex:2,forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0},t),t=c.cloneDeep(i);--t.zIndex,this._layer_01=new r.VectorLayer(e+"_station",i),this._layer_02=new r.VectorLayer(e+"_background",t)}var t=e.prototype;return t.setAreaCode=function(){var t=o(function*(e){var t=this;yield y("/geos/"+e+"_full.json").then(function(e){e=e.data,e=p(e,t._config.frontLayerStyle);t._layer_01.clear(),t._layer_01.addGeometry(e.polygons),t._layer_01.addGeometry(e.markers)})});return function(e){return t.apply(this,arguments)}}(),t.setBackgroundAreaCode=function(){var t=o(function*(e){var t=this;yield y("/geos/"+e+"_full.json").then(function(e){e=e.data,e=p(e,t._config.backgroundLayerStyle);t._layer_02.clear(),t._layer_02.addGeometry(e.polygons),t._layer_02.addGeometry(e.markers)})});return function(e){return t.apply(this,arguments)}}(),t.addTo=function(e){this._layer_01.addTo(e),this._layer_02.addTo(e)},t.clear=function(){this._layer_01.clear(),this._layer_02.clear()},t.dispose=function(){this._layer_01.clear().remove(),this._layer_02.clear().remove()},e}();function _(e){for(var t in e)0===e[t].length?delete e[t]:e[t].sort(function(e,t){return t.zoom-e.zoom})}function m(e){if("undefined"!==(e=f.trim(e))&&""!==e)return f._Number(e)}function g(e,t){var i,n=m(t.zoom),o=m(t.textOpacity),r=[m(t.textOffset[0]),m(t.textOffset[1])],l=m(t.textSize),a=m(t.iconSize),t=m(t.iconOpacity);if(f.isNull(o)&&f.isNull(r[0])&&f.isNull(r[1])&&f.isNull(l)&&f.isNull(a)&&f.isNull(t))for(var s,u=0;u<e.length;u++)(null==(s=e[u])?void 0:s.zoom)===n&&e.splice(u--,1);else n&&(i=e.find(function(e){return e.zoom===n}),console.log("非空",n,o,r,l,a,t),o={zoom:n,textOpacity:o,textOffset:f.isNull(r[0])&&r[1]?void 0:r.map(function(e){return f._Number(e)}),textSize:l,iconSize:a,iconOpacity:t},i?c.merge(i,o):e.push(o))}function b(e,t){e._cache||(e._cache={textDx:f._Number(e.textDx),textDy:f._Number(e.textDy),textOpacity:f._Number(e.textOpacity),textSize:f._Number(e.textSize)}),f.isNull(t.textOpacity)?e.textOpacity=e._cache.textOpacity:e.textOpacity=t.textOpacity,f.isNull(t.textSize)?e.textSize=e._cache.textSize:e.textSize=t.textSize,f.isNull(t.textOffset)?(e.textDx=e._cache.textDx,e.textDy=e._cache.textDy):(e.textDx=e._cache.textDx+t.textOffset[0],e.textDy=e._cache.textDy+t.textOffset[1])}function v(e,t){e._cache||(e._cache={markerWidth:f._Number(e.markerWidth),markerHeight:f._Number(e.markerHeight),markerOpacity:f._Number(e.markerOpacity)}),f.isNull(t.iconSize)?(e.markerWidth=e._cache.markerWidth,e.markerHeight=e._cache.markerHeight):(e.markerWidth=t.iconSize,e.markerHeight=t.iconSize),f.isNull(t.iconOpacity)?e.markerOpacity=e._cache.markerOpacity:e.markerOpacity=t.iconOpacity}function x(e,t,i){var n,e=e[t],o=!1;return f.isNull(null==e?void 0:e.length)?o=!1:(o=!0,n=e.find(function(e){return i>=e.zoom})),{id:t,hasRule:o,style:n}}var S=function(o){function e(e,t,i,n){e=o.call(this,e,t,i)||this;return e._offsetStyle=void 0,e._showIds=[],e._config=void 0,e._timer01=void 0,e._editMarker=void 0,e._editorContainer=void 0,e._config=n,e._onZoomed=e._onZoomed.bind(a(e)),e}l(e,o);var t=e.prototype;return t._debHandlerResize=function(){var e=this;clearTimeout(this._timer01),this._timer01=setTimeout(function(){e._onReszie()},100)},t._onZoomed=function(){this._editMarker&&this.editOffset(this._editMarker),this._debHandlerResize()},t._getConfig=function(e,t,i){var n=null==(n=e.properties)?void 0:n.offsetMemberId,o=null==(o=e.properties)?void 0:o.offsetMemberGroupId;if(!f.isNull(n)){var r=x(this._offsetStyle.memember,n,t),t=x(this._offsetStyle.group,o,t);if((!t.hasRule||t.hasRule&&t.style)&&!i.includes(o)&&i.push(o),this._showIds.includes(n)){o=c.cloneDeep(r);if(t.hasRule&&(o.hasRule=t.hasRule,!t.style||r.hasRule&&!r.style?o.style=void 0:o.style=c.merge({},t.style,o.style)),o.hasRule)return{parent:t,self:r,current:o}}else e.hide()}},t._onReszie=function(){var n,o,r=this;this._offsetStyle&&(n=this.getMap().getZoom(),o=[],this.forEach(function(e){var t=r._getConfig(e,n,o);if(!t)return e.show();if(!t.current.style)return e.hide();var i=e.getSymbol();i&&(f.isArray(i)?i.forEach(function(e){e.textSize?b(e,t.current.style):e.markerFile&&v(e,t.current.style)}):i.textSize?b(i,t.current.style):i.markerFile&&v(i,t.current.style),e.updateSymbol(i)),e.show()}),this._config.onGroupVisibleChange(o))},t.setActiveMememberIds=function(e){this._showIds=e,this._debHandlerResize()},t.setOffsetStyle=function(e){return e&&(_(e.group),_(e.memember)),console.log("新配置",e),this._offsetStyle=e,this._debHandlerResize(),this},t.editOffset=function(e){var n=this,t=+f.roundFixed(this.getMap().getZoom(),2),o=null==(i=e.properties)?void 0:i.offsetMemberId,r=null==(i=e.properties)?void 0:i.offsetMemberGroupId,i=null!=(i=this._getConfig(e,t,[]))?i:{flag:"自定义",parent:{hasRule:!1,id:r},self:{hasRule:!1,id:o}},e=(this._editorContainer||(this._editorContainer=document.createElement("div"),this._editorContainer.style.position="absolute",this._editorContainer.style.top="20px",this._editorContainer.style.right="20px",this._editorContainer.style.zIndex="200",this._editorContainer.style.color="white",this._editorContainer.style.backgroundColor="black",this.getMap().getContainer().appendChild(this._editorContainer)),this._editMarker=e,t),t=this._editorContainer,l=function(e,t){var i;n._offsetStyle&&(n._offsetStyle.group[r]=null!=(i=n._offsetStyle.group[r])?i:[],n._offsetStyle.memember[o]=null!=(i=n._offsetStyle.memember[o])?i:[],g(n._offsetStyle.group[r],t),g(n._offsetStyle.memember[o],e),console.log("给你更新",n._offsetStyle),n.setOffsetStyle(n._offsetStyle))},{parent:i,self:a}=i=i,s=(t.innerHTML="\n    <div>当前等级："+e+'</div>\n    <ul>\n      <li>\n        <b>所属分组</b>\n        <input value="'+i.id+'"/>\n      </li>\n      <li>\n        <b>配置等级</b>\n        <input value="'+(null==(e=i.style)?void 0:e.zoom)+'"/>\n      </li>\n      <li>\n        <b>字体大小</b>\n        <input value="'+(null==(e=i.style)?void 0:e.textSize)+'"/>\n      </li>\n      \n      <li>\n        <b>字体偏移</b>\n        <input value="'+(null==(e=i.style)||null==(e=e.textOffset)?void 0:e[0])+'"/>\n        <input value="'+(null==(e=i.style)||null==(e=e.textOffset)?void 0:e[1])+'"/>\n      </li>\n      <li>\n        <b>字体透明度</b>\n        <input value="'+(null==(e=i.style)?void 0:e.textOpacity)+'"/>\n      </li>\n      <li>\n        <b>图标尺寸</b>\n        <input value="'+(null==(e=i.style)?void 0:e.iconSize)+'"/>\n      </li>\n      <li>\n        <b>图标透明度</b>\n        <input value="'+(null==(e=i.style)?void 0:e.iconOpacity)+'"/>\n      </li>\n    </ul>\n    <ul>\n      <li>\n        <b>所属分组</b>\n        <input value="'+a.id+'"/>\n      </li>\n      <li>\n        <b>配置等级</b>\n        <input value="'+(null==(i=a.style)?void 0:i.zoom)+'"/>\n      </li>\n      <li>\n        <b>字体大小</b>\n        <input value="'+(null==(e=a.style)?void 0:e.textSize)+'"/>\n      </li>\n      <li>\n        <b>字体偏移</b>\n        <input value="'+(null==(i=a.style)||null==(e=i.textOffset)?void 0:e[0])+'"/>\n        <input value="'+(null==(i=a.style)||null==(e=i.textOffset)?void 0:e[1])+'"/>\n      </li>\n      <li>\n        <b>字体透明度</b>\n        <input value="'+(null==(i=a.style)?void 0:i.textOpacity)+'"/>\n      </li>\n      <li>\n        <b>图标尺寸</b>\n        <input value="'+(null==(e=a.style)?void 0:e.iconSize)+'"/>\n      </li>\n      <li>\n        <b>图标透明度</b>\n        <input value="'+(null==(i=a.style)?void 0:i.iconOpacity)+'"/>\n      </li>\n    </ul>\n    <button class="save">保存</button>\n  ',t.querySelectorAll("input"));t.querySelector(".save").onclick=function(){var e={zoom:s[1].value,textSize:s[2].value,textOffset:[s[3].value,s[4].value],textOpacity:s[5].value,iconSize:s[6].value,iconOpacity:s[7].value},t={zoom:s[9].value,textSize:s[10].value,textOffset:[s[11].value,s[12].value],textOpacity:s[13].value,iconSize:s[14].value,iconOpacity:s[15].value};l(t,e)}},t.addGeometry=function(e,t){o.prototype.addGeometry.call(this,e,t),this._debHandlerResize()},t.onAdd=function(){o.prototype.onAdd.call(this),this._debHandlerResize()},t.addTo=function(e){return o.prototype.addTo.call(this,e),e.on("zoomend",this._onZoomed),this},t.clear=function(){return clearTimeout(this._timer01),o.prototype.clear.call(this),this},t.remove=function(){var e;return clearTimeout(this._timer01),o.prototype.remove.call(this),null!=(e=this.getMap())&&e.off("zoomend",this._onZoomed),this},e}(r.VectorLayer),C=function(i){function e(e,t){e=i.call(this,e,t)||this;return e._testCount=0,e._heartbeatConfig={duration:200,isRestore:!0,isMouseIn:!1,originZindx:0,targetZindex:0,looping:!1,originStyle:{},targetStyle:{}},e._player=void 0,t.symbol&&(e._heartbeatConfig.originStyle=n.cloneDeep(t.symbol)),e._heartbeatConfig.duration=t.duration,e._heartbeatConfig.originZindx=f.defualtFormatter(0,t.zIndex),e._heartbeatConfig.targetZindex=1+e._heartbeatConfig.originZindx,e._heartbeatConfig.targetStyle={lineWidth:t.targetWidth},e._onMouseenter=e._onMouseenter.bind(a(e)),e._onMouseout=e._onMouseout.bind(a(e)),e.on("mouseenter",e._onMouseenter),e.on("mouseout",e._onMouseout),e}l(e,i);var t=e.prototype;return t.updateSymbol=function(e){return i.prototype.updateSymbol.call(this,e),this},t._onMouseenter=function(){this._heartbeatConfig.isMouseIn=!0,this.playActive()},t._onMouseout=function(){this._heartbeatConfig.isMouseIn=!1,this.playRestore(!0)},t.play=function(){var e=this.getSymbol();return f.isNull(e._targetWidth)&&(e._targetWidth=e.lineWidth),this.updateSymbol(e),this},t.playLoop=function(){var t,i=this;this._heartbeatConfig.looping=!0,this._clearPlayer(),(t=function(){var e=o(function*(){!i._heartbeatConfig.looping&&i._heartbeatConfig.isRestore||(i._heartbeatConfig.isRestore?(yield i.playActive(),i._heartbeatConfig.isRestore=!1):(yield i.playRestore(),i._heartbeatConfig.isRestore=!0),t())});return function t(){return e.apply(this,arguments)}}())()},t.playActive=function(){var e=o(function*(){var e=this;return this._clearPlayer(),this.setZIndex(this._heartbeatConfig.targetZindex),new Promise(function(t){e._player=e.animate({symbol:e._heartbeatConfig.targetStyle},{duration:e._heartbeatConfig.duration},function(e){"finished"===e.state.playState&&t(!0)})})});return function(){return e.apply(this,arguments)}}(),t.playRestore=function(){var t=o(function*(e){var i=this;if(!e||!this._heartbeatConfig.looping)return this._clearPlayer(),new Promise(function(t){i._player=i.animate({symbol:i._heartbeatConfig.originStyle},{duration:i._heartbeatConfig.duration},function(e){"finished"===e.state.playState&&(i._heartbeatConfig.looping||i.setZIndex(i._heartbeatConfig.originZindx),t(!0))})});this.playLoop()});return function(e){return t.apply(this,arguments)}}(),t.remove=function(){var e;return this.stopLoop(),null!=(e=this._player)&&e.finish(),this._clearPlayer(),this.off("mouseenter",this._onMouseenter),this.off("mouseout",this._onMouseout),null!=this&&null!=(e=this._clearAllListeners)&&e.call(this),i.prototype.remove.call(this),this},t._clearPlayer=function(){var e;null!=(e=this._player)&&e.pause(),this._animPlayer=void 0},t.stopLoop=function(){return this._heartbeatConfig.looping=!1,this},e}(r.LineString);C.registerJSONType("HeartbeatLineString"),e.BorderLayer=d,e.CityBoundry=h,e.HeartbeatLineString=C,e.OffsetLayer=S,e["default"]=function(e){u=e},Object.defineProperty(e,"__esModule",{value:!0})});
