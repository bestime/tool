/**
 * maptalks通用工具封装 => jUtilsMaptalks
 * @update 2024-10-16 18:19:21
 */
import{renderer,Layer,MultiPolygon,VectorLayer,LineString}from"maptalks";import{merge,cloneDeep}from"lodash-es";import axios from"axios";import{isNull,isArray,_Number}from"@bestime/utils_base";import"lodash";function asyncGeneratorStep(e,t,r,o,i,n,a){try{var s=e[n](a),c=s.value}catch(l){return void r(l)}s.done?t(c):Promise.resolve(c).then(o,i)}function _asyncToGenerator(s){return function(){var e=this,a=arguments;return new Promise(function(t,r){var o=s.apply(e,a);function i(e){asyncGeneratorStep(o,t,r,i,n,"next",e)}function n(e){asyncGeneratorStep(o,t,r,i,n,"throw",e)}i(undefined)})}}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var staticBase,BorderLayer=function(o){function e(e,t,r){e=o.call(this,e,r)||this;return e._config=void 0,e._config=t,e}return _inheritsLoose(e,o),e.prototype.getConfig=function(){return this._config},e}(Layer),BorderLayerRenderer=function(e){function t(){return e.apply(this,arguments)||this}_inheritsLoose(t,e);var r=t.prototype;return r.checkResources=function(){return[]},r.draw=function(){this._drawData(),this.completeRender()},r.drawOnInteracting=function(){this.draw()},r._drawData=function(){var e=this.layer.getConfig(),t=this.getMap().getSize(),r=(this.prepareCanvas(),this.context);r.fillStyle=e.backgroundColor,r.fillRect(0,0,t.width,t.height),r.lineWidth=e.borderWidth,r.strokeStyle=e.borderColor,r.strokeRect(0,0,t.width,t.height)},t}(renderer.CanvasRenderer);function setBaseUrl(e){staticBase=e}function resolveBaseUrl(e){return staticBase+"/readonly-utils_maptalks-static"+e}function requestStaticFile(e){return axios({baseURL:"",url:resolveBaseUrl(e)})}function getPolygonLilst(e){var t=[];return null!=e&&null!=(e=e.features)&&e.forEach(function(e){"MultiPolygon"===e.geometry.type&&(e=new MultiPolygon(e.geometry.coordinates,{properties:e.properties,symbol:{polygonFill:"transparent",lineWidth:1,lineColor:"#ddd"}}),t.push(e))}),t}BorderLayer.registerRenderer("canvas",BorderLayerRenderer);var CityBoundry=function(){function e(e,t){this._layer=void 0;t=merge({zIndex:1,forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0},t);this._layer=new VectorLayer(e,t)}var t=e.prototype;return t.setAreaCode=function(){var t=_asyncToGenerator(function*(e){var t=this;yield requestStaticFile("/geos/"+e+"_full.json").then(function(e){e=e.data,e=getPolygonLilst(e);t._layer.clear(),t._layer.addGeometry(e)})});return function(e){return t.apply(this,arguments)}}(),t.addTo=function(e){this._layer.addTo(e)},t.clear=function(){this._layer.clear()},t.dispose=function(){this._layer.clear().remove()},e}();function updateTextSymbol(e,t){e._cache||(e._cache={textDx:_Number(e.textDx),textDy:_Number(e.textDy),textOpacity:_Number(e.textOpacity),textSize:_Number(e.textSize)}),isNull(t.textOpacity)?e.textOpacity=e._cache.textOpacity:e.textOpacity=t.textOpacity,isNull(t.textSize)?e.textSize=e._cache.textSize:e.textSize=t.textSize,isNull(t.textOffset)?(e.textDx=e._cache.textDx,e.textDy=e._cache.textDy):(e.textDx=e._cache.textDx+t.textOffset[0],e.textDy=e._cache.textDy+t.textOffset[1])}function updateIconSymbol(e,t){e._cache||(e._cache={markerWidth:_Number(e.markerWidth),markerHeight:_Number(e.markerHeight),markerOpacity:_Number(e.markerOpacity)}),isNull(t.iconSize)?(e.markerWidth=e._cache.markerWidth,e.markerHeight=e._cache.markerHeight):(e.markerWidth=t.iconSize,e.markerHeight=t.iconSize),isNull(t.iconOpacity)?e.markerOpacity=e._cache.markerOpacity:e.markerOpacity=t.iconOpacity,console.log("图标",e,e._cache.iconSize,t.iconSize)}function getOneConfig(e,t,r){var o,t=e[t],e=!1;return isNull(null==t?void 0:t.length)?e=!1:(e=!0,o=t.find(function(e){return r>e.zoom})),{hasRule:e,style:o}}var OffsetLayer=function(o){function e(e,t,r){e=o.call(this,e,t,r)||this;return e._offsetStyle=void 0,e._showIds=[],e._onResize=e._onResize.bind(_assertThisInitialized(e)),e}_inheritsLoose(e,o);var t=e.prototype;return t._onResize=function(){var s,c=this;this._offsetStyle&&(s=this.getMap().getZoom(),this.forEach(function(e){var t=null==(t=e.properties)?void 0:t.offsetMemberId,r=null==(r=e.properties)?void 0:r.offsetMemberGroupId;if(!isNull(t)){if(!c._showIds.includes(t))return console.log("直接隐藏"),e.hide();console.log("++++++++++++"),e.show();var o,i=getOneConfig(c._offsetStyle.memember,t,s),n=getOneConfig(c._offsetStyle.group,r,s),a=cloneDeep(i);return n.hasRule&&(a.hasRule=n.hasRule,n.style?a.style=merge({},n.style,i.style):a.style=void 0),a.hasRule?(o=e.getSymbol(),console.log("找到配置",r,t,n,i,a),a.style&&a.style?(o&&(isArray(o)?o.forEach(function(e){e.textSize?updateTextSymbol(e,a.style):e.markerFile&&updateIconSymbol(e,a.style)}):o.textSize?updateTextSymbol(o,a.style):o.markerFile&&updateIconSymbol(o,a.style),e.updateSymbol(o)),void e.show()):e.hide()):void 0}}))},t.setActiveMememberIds=function(e){this._showIds=e,console.log("显示的成员",e),this._onResize()},t.setOffsetStyle=function(e){for(var t in e.memember)e.memember[t].sort(function(e,t){return t.zoom-e.zoom});return this._offsetStyle=e,this._onResize(),this},t.addGeometry=function(e,t){o.prototype.addGeometry.call(this,e,t),console.log("被添加了元素"),this._onResize()},t.onAdd=function(){o.prototype.onAdd.call(this),this._onResize()},t.addTo=function(e){return o.prototype.addTo.call(this,e),e.on("zoomend",this._onResize),this},t.clear=function(){return o.prototype.clear.call(this),this},t.remove=function(){var e;return o.prototype.remove.call(this),null!=(e=this.getMap())&&e.off("zoomend",this._onResize),this},e}(VectorLayer),HeartbeatLineString=function(r){function e(e,t){return r.call(this,e,t)||this}return _inheritsLoose(e,r),e}(LineString);function main(e){setBaseUrl(e)}HeartbeatLineString.registerJSONType("HeartbeatLineString");export{BorderLayer,CityBoundry,HeartbeatLineString,OffsetLayer,main as default};
