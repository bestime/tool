/**
 * maptalks通用工具封装 => jUtilsMaptalks
 * @update 2024-10-19 00:43:28
 */
import{renderer,Layer,MultiPolygon,Marker,VectorLayer,LineString}from"maptalks";import{merge,cloneDeep}from"lodash-es";import axios from"axios";import{isArray,isNull,roundFixed,_Number,trim,defualtFormatter}from"@bestime/utils_base";import{cloneDeep as cloneDeep$1}from"lodash";function asyncGeneratorStep(e,t,i,n,o,r,a){try{var l=e[r](a),s=l.value}catch(u){return void i(u)}l.done?t(s):Promise.resolve(s).then(n,o)}function _asyncToGenerator(l){return function(){var e=this,a=arguments;return new Promise(function(t,i){var n=l.apply(e,a);function o(e){asyncGeneratorStep(n,t,i,o,r,"next",e)}function r(e){asyncGeneratorStep(n,t,i,o,r,"throw",e)}o(undefined)})}}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var staticBase,BorderLayer=function(n){function e(e,t,i){e=n.call(this,e,i)||this;return e._config=void 0,e._config=t,e}return _inheritsLoose(e,n),e.prototype.getConfig=function(){return this._config},e}(Layer),BorderLayerRenderer=function(e){function t(){return e.apply(this,arguments)||this}_inheritsLoose(t,e);var i=t.prototype;return i.checkResources=function(){return[]},i.draw=function(){this._drawData(),this.completeRender()},i.drawOnInteracting=function(){this.draw()},i._drawData=function(){var e=this.layer.getConfig(),t=this.getMap().getSize(),i=(this.prepareCanvas(),this.context);i.fillStyle=e.backgroundColor,i.fillRect(0,0,t.width,t.height),i.lineWidth=e.borderWidth,i.strokeStyle=e.borderColor,i.strokeRect(0,0,t.width,t.height)},t}(renderer.CanvasRenderer);function setBaseUrl(e){staticBase=e}function resolveBaseUrl(e){return staticBase+"/readonly-utils_maptalks-static"+e}function requestStaticFile(e){return axios({baseURL:"",url:resolveBaseUrl(e)})}function getPolygonLilst(e,i){var n=[],o=[];return null!=e&&null!=(e=e.features)&&e.forEach(function(e){var t;"MultiPolygon"===e.geometry.type&&(t=new MultiPolygon(e.geometry.coordinates,{properties:e.properties,symbol:{polygonFill:i.backgroundColor,lineWidth:i.lineWidth,lineColor:i.lineColor}}),isArray(e.properties.center)&&(e=new Marker(e.properties.center,{symbol:{textFaceName:"Microsoft YaHei",textName:e.properties.name,textWeight:"normal",textStyle:"normal",textSize:i.fontSize,textFont:null,textFill:i.fontColor,textHaloFill:i.fontHaloFill,textHaloRadius:i.fontHaloRadius,textDx:0,textDy:0,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textAlign:"center"}}),o.push(e)),n.push(t))}),{polygons:n,markers:o}}BorderLayer.registerRenderer("canvas",BorderLayerRenderer);var CityBoundry=function(){function e(e,t,i){this._layer_01=void 0,this._layer_02=void 0,this._config=void 0,this._config={backgroundLayerStyle:merge({backgroundColor:"rgba(0,0,0,0.1)",lineColor:"#1a504e",lineWidth:1,fontSize:12,fontColor:"#66a1a3",fontHaloFill:"black",fontHaloRadius:1},i.backgroundLayerStyle),frontLayerStyle:merge({backgroundColor:"#013733",lineColor:"#1a504e",lineWidth:1,fontColor:"white",fontSize:12,fontHaloFill:"black",fontHaloRadius:1},i.frontLayerStyle)};i=merge({zIndex:2,forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0},t),t=cloneDeep(i);--t.zIndex,this._layer_01=new VectorLayer(e+"_station",i),this._layer_02=new VectorLayer(e+"_background",t)}var t=e.prototype;return t.setAreaCode=function(){var t=_asyncToGenerator(function*(e){var t=this;yield requestStaticFile("/geos/"+e+"_full.json").then(function(e){e=e.data,e=getPolygonLilst(e,t._config.frontLayerStyle);t._layer_01.clear(),t._layer_01.addGeometry(e.polygons),t._layer_01.addGeometry(e.markers)})});return function(e){return t.apply(this,arguments)}}(),t.setBackgroundAreaCode=function(){var t=_asyncToGenerator(function*(e){var t=this;yield requestStaticFile("/geos/"+e+"_full.json").then(function(e){e=e.data,e=getPolygonLilst(e,t._config.backgroundLayerStyle);t._layer_02.clear(),t._layer_02.addGeometry(e.polygons),t._layer_02.addGeometry(e.markers)})});return function(e){return t.apply(this,arguments)}}(),t.addTo=function(e){this._layer_01.addTo(e),this._layer_02.addTo(e)},t.clear=function(){this._layer_01.clear(),this._layer_02.clear()},t.dispose=function(){this._layer_01.clear().remove(),this._layer_02.clear().remove()},e}();function sortOneGroupAndClear(e){for(var t in e)0===e[t].length?delete e[t]:e[t].sort(function(e,t){return t.zoom-e.zoom})}function hasSetV(e){if("undefined"!==(e=trim(e))&&""!==e)return _Number(e)}function getEditStyle(e,t){var i,n=hasSetV(t.zoom),o=hasSetV(t.textOpacity),r=[hasSetV(t.textOffset[0]),hasSetV(t.textOffset[1])],a=hasSetV(t.textSize),l=hasSetV(t.iconSize),t=hasSetV(t.iconOpacity);if(isNull(o)&&isNull(r[0])&&isNull(r[1])&&isNull(a)&&isNull(l)&&isNull(t))for(var s,u=0;u<e.length;u++)(null==(s=e[u])?void 0:s.zoom)===n&&e.splice(u--,1);else n&&(i=e.find(function(e){return e.zoom===n}),console.log("非空",n,o,r,a,l,t),o={zoom:n,textOpacity:o,textOffset:isNull(r[0])&&r[1]?void 0:r.map(function(e){return _Number(e)}),textSize:a,iconSize:l,iconOpacity:t},i?merge(i,o):e.push(o))}function createEditorHTML(e,t,i,n){var{parent:i,self:o}=i,r=(t.innerHTML="\n    <div>当前等级："+e+'</div>\n    <ul>\n      <li>\n        <b>所属分组</b>\n        <input value="'+i.id+'"/>\n      </li>\n      <li>\n        <b>配置等级</b>\n        <input value="'+(null==(e=i.style)?void 0:e.zoom)+'"/>\n      </li>\n      <li>\n        <b>字体大小</b>\n        <input value="'+(null==(e=i.style)?void 0:e.textSize)+'"/>\n      </li>\n      \n      <li>\n        <b>字体偏移</b>\n        <input value="'+(null==(e=i.style)||null==(e=e.textOffset)?void 0:e[0])+'"/>\n        <input value="'+(null==(e=i.style)||null==(e=e.textOffset)?void 0:e[1])+'"/>\n      </li>\n      <li>\n        <b>字体透明度</b>\n        <input value="'+(null==(e=i.style)?void 0:e.textOpacity)+'"/>\n      </li>\n      <li>\n        <b>图标尺寸</b>\n        <input value="'+(null==(e=i.style)?void 0:e.iconSize)+'"/>\n      </li>\n      <li>\n        <b>图标透明度</b>\n        <input value="'+(null==(e=i.style)?void 0:e.iconOpacity)+'"/>\n      </li>\n    </ul>\n    <ul>\n      <li>\n        <b>所属分组</b>\n        <input value="'+o.id+'"/>\n      </li>\n      <li>\n        <b>配置等级</b>\n        <input value="'+(null==(i=o.style)?void 0:i.zoom)+'"/>\n      </li>\n      <li>\n        <b>字体大小</b>\n        <input value="'+(null==(e=o.style)?void 0:e.textSize)+'"/>\n      </li>\n      <li>\n        <b>字体偏移</b>\n        <input value="'+(null==(i=o.style)||null==(e=i.textOffset)?void 0:e[0])+'"/>\n        <input value="'+(null==(i=o.style)||null==(e=i.textOffset)?void 0:e[1])+'"/>\n      </li>\n      <li>\n        <b>字体透明度</b>\n        <input value="'+(null==(i=o.style)?void 0:i.textOpacity)+'"/>\n      </li>\n      <li>\n        <b>图标尺寸</b>\n        <input value="'+(null==(e=o.style)?void 0:e.iconSize)+'"/>\n      </li>\n      <li>\n        <b>图标透明度</b>\n        <input value="'+(null==(i=o.style)?void 0:i.iconOpacity)+'"/>\n      </li>\n    </ul>\n    <button class="save">保存</button>\n  ',t.querySelectorAll("input"));t.querySelector(".save").onclick=function(){var e={zoom:r[1].value,textSize:r[2].value,textOffset:[r[3].value,r[4].value],textOpacity:r[5].value,iconSize:r[6].value,iconOpacity:r[7].value},t={zoom:r[9].value,textSize:r[10].value,textOffset:[r[11].value,r[12].value],textOpacity:r[13].value,iconSize:r[14].value,iconOpacity:r[15].value};n(t,e)}}function updateTextSymbol(e,t){e._cache||(e._cache={textDx:_Number(e.textDx),textDy:_Number(e.textDy),textOpacity:_Number(e.textOpacity),textSize:_Number(e.textSize)}),isNull(t.textOpacity)?e.textOpacity=e._cache.textOpacity:e.textOpacity=t.textOpacity,isNull(t.textSize)?e.textSize=e._cache.textSize:e.textSize=t.textSize,isNull(t.textOffset)?(e.textDx=e._cache.textDx,e.textDy=e._cache.textDy):(e.textDx=e._cache.textDx+t.textOffset[0],e.textDy=e._cache.textDy+t.textOffset[1])}function updateIconSymbol(e,t){e._cache||(e._cache={markerWidth:_Number(e.markerWidth),markerHeight:_Number(e.markerHeight),markerOpacity:_Number(e.markerOpacity)}),isNull(t.iconSize)?(e.markerWidth=e._cache.markerWidth,e.markerHeight=e._cache.markerHeight):(e.markerWidth=t.iconSize,e.markerHeight=t.iconSize),isNull(t.iconOpacity)?e.markerOpacity=e._cache.markerOpacity:e.markerOpacity=t.iconOpacity}function getOneConfig(e,t,i){var n,e=e[t],o=!1;return isNull(null==e?void 0:e.length)?o=!1:(o=!0,n=e.find(function(e){return i>=e.zoom})),{id:t,hasRule:o,style:n}}var OffsetLayer=function(o){function e(e,t,i,n){e=o.call(this,e,t,i)||this;return e._offsetStyle=void 0,e._showIds=[],e._config=void 0,e._timer01=void 0,e._editMarker=void 0,e._editorContainer=void 0,e._config=n,e._onZoomed=e._onZoomed.bind(_assertThisInitialized(e)),e}_inheritsLoose(e,o);var t=e.prototype;return t._debHandlerResize=function(){var e=this;clearTimeout(this._timer01),this._timer01=setTimeout(function(){e._onReszie()},100)},t._onZoomed=function(){this._editMarker&&this.editOffset(this._editMarker),this._debHandlerResize()},t._getConfig=function(e,t,i){var n=null==(n=e.properties)?void 0:n.offsetMemberId,o=null==(o=e.properties)?void 0:o.offsetMemberGroupId;if(!isNull(n)){var r=getOneConfig(this._offsetStyle.memember,n,t),t=getOneConfig(this._offsetStyle.group,o,t);if((!t.hasRule||t.hasRule&&t.style)&&!i.includes(o)&&i.push(o),this._showIds.includes(n)){o=cloneDeep(r);if(t.hasRule&&(o.hasRule=t.hasRule,!t.style||r.hasRule&&!r.style?o.style=void 0:o.style=merge({},t.style,o.style)),o.hasRule)return{parent:t,self:r,current:o}}else e.hide()}},t._onReszie=function(){var n,o,r=this;this._offsetStyle&&(n=this.getMap().getZoom(),o=[],this.forEach(function(e){var t=r._getConfig(e,n,o);if(!t)return e.show();if(!t.current.style)return e.hide();var i=e.getSymbol();i&&(isArray(i)?i.forEach(function(e){e.textSize?updateTextSymbol(e,t.current.style):e.markerFile&&updateIconSymbol(e,t.current.style)}):i.textSize?updateTextSymbol(i,t.current.style):i.markerFile&&updateIconSymbol(i,t.current.style),e.updateSymbol(i)),e.show()}),this._config.onGroupVisibleChange(o))},t.setActiveMememberIds=function(e){this._showIds=e,this._debHandlerResize()},t.setOffsetStyle=function(e){return e&&(sortOneGroupAndClear(e.group),sortOneGroupAndClear(e.memember)),console.log("新配置",e),this._offsetStyle=e,this._debHandlerResize(),this},t.editOffset=function(e){var n=this,t=+roundFixed(this.getMap().getZoom(),2),o=null==(i=e.properties)?void 0:i.offsetMemberId,r=null==(i=e.properties)?void 0:i.offsetMemberGroupId,i=null!=(i=this._getConfig(e,t,[]))?i:{flag:"自定义",parent:{hasRule:!1,id:r},self:{hasRule:!1,id:o}};this._editorContainer||(this._editorContainer=document.createElement("div"),this._editorContainer.style.position="absolute",this._editorContainer.style.top="20px",this._editorContainer.style.right="20px",this._editorContainer.style.zIndex="200",this._editorContainer.style.color="white",this._editorContainer.style.backgroundColor="black",this.getMap().getContainer().appendChild(this._editorContainer)),this._editMarker=e,createEditorHTML(t,this._editorContainer,i,function(e,t){var i;n._offsetStyle&&(n._offsetStyle.group[r]=null!=(i=n._offsetStyle.group[r])?i:[],n._offsetStyle.memember[o]=null!=(i=n._offsetStyle.memember[o])?i:[],getEditStyle(n._offsetStyle.group[r],t),getEditStyle(n._offsetStyle.memember[o],e),console.log("给你更新",n._offsetStyle),n.setOffsetStyle(n._offsetStyle))})},t.addGeometry=function(e,t){o.prototype.addGeometry.call(this,e,t),this._debHandlerResize()},t.onAdd=function(){o.prototype.onAdd.call(this),this._debHandlerResize()},t.addTo=function(e){return o.prototype.addTo.call(this,e),e.on("zoomend",this._onZoomed),this},t.clear=function(){return clearTimeout(this._timer01),o.prototype.clear.call(this),this},t.remove=function(){var e;return clearTimeout(this._timer01),o.prototype.remove.call(this),null!=(e=this.getMap())&&e.off("zoomend",this._onZoomed),this},e}(VectorLayer),HeartbeatLineString=function(i){function e(e,t){e=i.call(this,e,t)||this;return e._testCount=0,e._heartbeatConfig={duration:200,isRestore:!0,isMouseIn:!1,originZindx:0,targetZindex:0,looping:!1,originStyle:{},targetStyle:{}},e._player=void 0,t.symbol&&(e._heartbeatConfig.originStyle=cloneDeep$1(t.symbol)),e._heartbeatConfig.duration=t.duration,e._heartbeatConfig.originZindx=defualtFormatter(0,t.zIndex),e._heartbeatConfig.targetZindex=1+e._heartbeatConfig.originZindx,e._heartbeatConfig.targetStyle={lineWidth:t.targetWidth},e._onMouseenter=e._onMouseenter.bind(_assertThisInitialized(e)),e._onMouseout=e._onMouseout.bind(_assertThisInitialized(e)),e.on("mouseenter",e._onMouseenter),e.on("mouseout",e._onMouseout),e}_inheritsLoose(e,i);var t=e.prototype;return t.updateSymbol=function(e){return i.prototype.updateSymbol.call(this,e),this},t._onMouseenter=function(){this._heartbeatConfig.isMouseIn=!0,this.playActive()},t._onMouseout=function(){this._heartbeatConfig.isMouseIn=!1,this.playRestore(!0)},t.play=function(){var e=this.getSymbol();return isNull(e._targetWidth)&&(e._targetWidth=e.lineWidth),this.updateSymbol(e),this},t.playLoop=function(){var t,i=this;this._heartbeatConfig.looping=!0,this._clearPlayer(),(t=function(){var e=_asyncToGenerator(function*(){!i._heartbeatConfig.looping&&i._heartbeatConfig.isRestore||(i._heartbeatConfig.isRestore?(yield i.playActive(),i._heartbeatConfig.isRestore=!1):(yield i.playRestore(),i._heartbeatConfig.isRestore=!0),t())});return function t(){return e.apply(this,arguments)}}())()},t.playActive=function(){var e=_asyncToGenerator(function*(){var e=this;return this._clearPlayer(),this.setZIndex(this._heartbeatConfig.targetZindex),new Promise(function(t){e._player=e.animate({symbol:e._heartbeatConfig.targetStyle},{duration:e._heartbeatConfig.duration},function(e){"finished"===e.state.playState&&t(!0)})})});return function(){return e.apply(this,arguments)}}(),t.playRestore=function(){var t=_asyncToGenerator(function*(e){var i=this;if(!e||!this._heartbeatConfig.looping)return this._clearPlayer(),new Promise(function(t){i._player=i.animate({symbol:i._heartbeatConfig.originStyle},{duration:i._heartbeatConfig.duration},function(e){"finished"===e.state.playState&&(i._heartbeatConfig.looping||i.setZIndex(i._heartbeatConfig.originZindx),t(!0))})});this.playLoop()});return function(e){return t.apply(this,arguments)}}(),t.remove=function(){var e;return this.stopLoop(),null!=(e=this._player)&&e.finish(),this._clearPlayer(),this.off("mouseenter",this._onMouseenter),this.off("mouseout",this._onMouseout),null!=this&&null!=(e=this._clearAllListeners)&&e.call(this),i.prototype.remove.call(this),this},t._clearPlayer=function(){var e;null!=(e=this._player)&&e.pause(),this._animPlayer=void 0},t.stopLoop=function(){return this._heartbeatConfig.looping=!1,this},e}(LineString);function main(e){setBaseUrl(e)}HeartbeatLineString.registerJSONType("HeartbeatLineString");export{BorderLayer,CityBoundry,HeartbeatLineString,OffsetLayer,main as default};
