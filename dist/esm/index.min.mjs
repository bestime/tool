/**
 * maptalks通用工具封装 => jUtilsMaptalks
 * @update 2024-10-18 16:24:16
 */
import{renderer,Layer,MultiPolygon,Marker,VectorLayer,LineString}from"maptalks";import{merge,cloneDeep}from"lodash-es";import axios from"axios";import{isArray,isNull,_Number,defualtFormatter}from"@bestime/utils_base";import{cloneDeep as cloneDeep$1}from"lodash";function asyncGeneratorStep(e,t,r,o,i,n,a){try{var s=e[n](a),l=s.value}catch(u){return void r(u)}s.done?t(l):Promise.resolve(l).then(o,i)}function _asyncToGenerator(s){return function(){var e=this,a=arguments;return new Promise(function(t,r){var o=s.apply(e,a);function i(e){asyncGeneratorStep(o,t,r,i,n,"next",e)}function n(e){asyncGeneratorStep(o,t,r,i,n,"throw",e)}i(undefined)})}}function _inheritsLoose(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(e,t){return e.__proto__=t,e})(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var staticBase,BorderLayer=function(o){function e(e,t,r){e=o.call(this,e,r)||this;return e._config=void 0,e._config=t,e}return _inheritsLoose(e,o),e.prototype.getConfig=function(){return this._config},e}(Layer),BorderLayerRenderer=function(e){function t(){return e.apply(this,arguments)||this}_inheritsLoose(t,e);var r=t.prototype;return r.checkResources=function(){return[]},r.draw=function(){this._drawData(),this.completeRender()},r.drawOnInteracting=function(){this.draw()},r._drawData=function(){var e=this.layer.getConfig(),t=this.getMap().getSize(),r=(this.prepareCanvas(),this.context);r.fillStyle=e.backgroundColor,r.fillRect(0,0,t.width,t.height),r.lineWidth=e.borderWidth,r.strokeStyle=e.borderColor,r.strokeRect(0,0,t.width,t.height)},t}(renderer.CanvasRenderer);function setBaseUrl(e){staticBase=e}function resolveBaseUrl(e){return staticBase+"/readonly-utils_maptalks-static"+e}function requestStaticFile(e){return axios({baseURL:"",url:resolveBaseUrl(e)})}function getPolygonLilst(e,r){var o=[],i=[];return null!=e&&null!=(e=e.features)&&e.forEach(function(e){var t;"MultiPolygon"===e.geometry.type&&(t=new MultiPolygon(e.geometry.coordinates,{properties:e.properties,symbol:{polygonFill:r.backgroundColor,lineWidth:r.lineWidth,lineColor:r.lineColor}}),isArray(e.properties.center)&&(e=new Marker(e.properties.center,{symbol:{textFaceName:"Microsoft YaHei",textName:e.properties.name,textWeight:"normal",textStyle:"normal",textSize:r.fontSize,textFont:null,textFill:r.fontColor,textHaloFill:r.fontHaloFill,textHaloRadius:r.fontHaloRadius,textDx:0,textDy:0,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textAlign:"center"}}),i.push(e)),o.push(t))}),{polygons:o,markers:i}}BorderLayer.registerRenderer("canvas",BorderLayerRenderer);var CityBoundry=function(){function e(e,t,r){this._layer_01=void 0,this._layer_02=void 0,this._config=void 0,this._config={backgroundLayerStyle:merge({backgroundColor:"rgba(0,0,0,0.1)",lineColor:"#1a504e",lineWidth:1,fontSize:12,fontColor:"#66a1a3",fontHaloFill:"black",fontHaloRadius:1},r.backgroundLayerStyle),frontLayerStyle:merge({backgroundColor:"#013733",lineColor:"#1a504e",lineWidth:1,fontColor:"white",fontSize:12,fontHaloFill:"black",fontHaloRadius:1},r.frontLayerStyle)};r=merge({zIndex:2,forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0},t),t=cloneDeep(r);--t.zIndex,this._layer_01=new VectorLayer(e+"_station",r),this._layer_02=new VectorLayer(e+"_background",t)}var t=e.prototype;return t.setAreaCode=function(){var t=_asyncToGenerator(function*(e){var t=this;yield requestStaticFile("/geos/"+e+"_full.json").then(function(e){e=e.data,e=getPolygonLilst(e,t._config.frontLayerStyle);t._layer_01.clear(),t._layer_01.addGeometry(e.polygons),t._layer_01.addGeometry(e.markers)})});return function(e){return t.apply(this,arguments)}}(),t.setBackgroundAreaCode=function(){var t=_asyncToGenerator(function*(e){var t=this;yield requestStaticFile("/geos/"+e+"_full.json").then(function(e){e=e.data,e=getPolygonLilst(e,t._config.backgroundLayerStyle);t._layer_02.clear(),t._layer_02.addGeometry(e.polygons),t._layer_02.addGeometry(e.markers)})});return function(e){return t.apply(this,arguments)}}(),t.addTo=function(e){this._layer_01.addTo(e),this._layer_02.addTo(e)},t.clear=function(){this._layer_01.clear(),this._layer_02.clear()},t.dispose=function(){this._layer_01.clear().remove(),this._layer_02.clear().remove()},e}();function updateTextSymbol(e,t){e._cache||(e._cache={textDx:_Number(e.textDx),textDy:_Number(e.textDy),textOpacity:_Number(e.textOpacity),textSize:_Number(e.textSize)}),isNull(t.textOpacity)?e.textOpacity=e._cache.textOpacity:e.textOpacity=t.textOpacity,isNull(t.textSize)?e.textSize=e._cache.textSize:e.textSize=t.textSize,isNull(t.textOffset)?(e.textDx=e._cache.textDx,e.textDy=e._cache.textDy):(e.textDx=e._cache.textDx+t.textOffset[0],e.textDy=e._cache.textDy+t.textOffset[1])}function updateIconSymbol(e,t){e._cache||(e._cache={markerWidth:_Number(e.markerWidth),markerHeight:_Number(e.markerHeight),markerOpacity:_Number(e.markerOpacity)}),isNull(t.iconSize)?(e.markerWidth=e._cache.markerWidth,e.markerHeight=e._cache.markerHeight):(e.markerWidth=t.iconSize,e.markerHeight=t.iconSize),isNull(t.iconOpacity)?e.markerOpacity=e._cache.markerOpacity:e.markerOpacity=t.iconOpacity}function getOneConfig(e,t,r){var o,t=e[t],e=!1;return isNull(null==t?void 0:t.length)?e=!1:(e=!0,o=t.find(function(e){return r>e.zoom})),{hasRule:e,style:o}}var OffsetLayer=function(i){function e(e,t,r,o){e=i.call(this,e,t,r)||this;return e._offsetStyle=void 0,e._showIds=[],e._config=void 0,e._timer01=void 0,e._config=o,e._onZoomed=e._onZoomed.bind(_assertThisInitialized(e)),e}_inheritsLoose(e,i);var t=e.prototype;return t._debHandlerResize=function(){var e=this;clearTimeout(this._timer01),this._timer01=setTimeout(function(){e._onReszie()},100)},t._onZoomed=function(){this._debHandlerResize()},t._onReszie=function(){var a,s,l=this;this._offsetStyle&&(a=this.getMap().getZoom(),s=[],this.forEach(function(e){var t=null==(t=e.properties)?void 0:t.offsetMemberId,r=null==(r=e.properties)?void 0:r.offsetMemberGroupId;if(!isNull(t)){var o=getOneConfig(l._offsetStyle.memember,t,a),i=getOneConfig(l._offsetStyle.group,r,a);if((!i.hasRule||i.hasRule&&i.style)&&!s.includes(r)&&s.push(r),!l._showIds.includes(t))return e.hide();e.show();var n=cloneDeep(o);return i.hasRule&&(n.hasRule=i.hasRule,!i.style||o.hasRule&&!o.style?n.style=void 0:n.style=merge({},i.style,o.style)),n.hasRule?(r=e.getSymbol(),n.style&&n.style?(r&&(isArray(r)?r.forEach(function(e){e.textSize?updateTextSymbol(e,n.style):e.markerFile&&updateIconSymbol(e,n.style)}):r.textSize?updateTextSymbol(r,n.style):r.markerFile&&updateIconSymbol(r,n.style),e.updateSymbol(r)),void e.show()):e.hide()):void 0}}),this._config.onGroupVisibleChange(s))},t.setActiveMememberIds=function(e){this._showIds=e,this._debHandlerResize()},t.setOffsetStyle=function(e){if(e)for(var t in e.memember)e.memember[t].sort(function(e,t){return t.zoom-e.zoom});return this._offsetStyle=e,this._debHandlerResize(),this},t.addGeometry=function(e,t){i.prototype.addGeometry.call(this,e,t),this._debHandlerResize()},t.onAdd=function(){i.prototype.onAdd.call(this),this._debHandlerResize()},t.addTo=function(e){return i.prototype.addTo.call(this,e),e.on("zoomend",this._onZoomed),this},t.clear=function(){return clearTimeout(this._timer01),i.prototype.clear.call(this),this},t.remove=function(){var e;return clearTimeout(this._timer01),i.prototype.remove.call(this),null!=(e=this.getMap())&&e.off("zoomend",this._onZoomed),this},e}(VectorLayer),HeartbeatLineString=function(r){function e(e,t){e=r.call(this,e,t)||this;return e._testCount=0,e._heartbeatConfig={duration:200,isRestore:!0,isMouseIn:!1,originZindx:0,targetZindex:0,looping:!1,originStyle:{},targetStyle:{}},e._player=void 0,t.symbol&&(e._heartbeatConfig.originStyle=cloneDeep$1(t.symbol)),e._heartbeatConfig.duration=t.duration,e._heartbeatConfig.originZindx=defualtFormatter(0,t.zIndex),e._heartbeatConfig.targetZindex=1+e._heartbeatConfig.originZindx,e._heartbeatConfig.targetStyle={lineWidth:t.targetWidth},e._onMouseenter=e._onMouseenter.bind(_assertThisInitialized(e)),e._onMouseout=e._onMouseout.bind(_assertThisInitialized(e)),e.on("mouseenter",e._onMouseenter),e.on("mouseout",e._onMouseout),e}_inheritsLoose(e,r);var t=e.prototype;return t.updateSymbol=function(e){return r.prototype.updateSymbol.call(this,e),this},t._onMouseenter=function(){this._heartbeatConfig.isMouseIn=!0,this.playActive()},t._onMouseout=function(){this._heartbeatConfig.isMouseIn=!1,this.playRestore(!0)},t.play=function(){var e=this.getSymbol();return isNull(e._targetWidth)&&(e._targetWidth=e.lineWidth),this.updateSymbol(e),this},t.playLoop=function(){var t,r=this;this._heartbeatConfig.looping=!0,this._clearPlayer(),(t=function(){var e=_asyncToGenerator(function*(){!r._heartbeatConfig.looping&&r._heartbeatConfig.isRestore||(r._heartbeatConfig.isRestore?(yield r.playActive(),r._heartbeatConfig.isRestore=!1):(yield r.playRestore(),r._heartbeatConfig.isRestore=!0),t())});return function t(){return e.apply(this,arguments)}}())()},t.playActive=function(){var e=_asyncToGenerator(function*(){var e=this;return this._clearPlayer(),this.setZIndex(this._heartbeatConfig.targetZindex),new Promise(function(t){e._player=e.animate({symbol:e._heartbeatConfig.targetStyle},{duration:e._heartbeatConfig.duration},function(e){"finished"===e.state.playState&&t(!0)})})});return function(){return e.apply(this,arguments)}}(),t.playRestore=function(){var t=_asyncToGenerator(function*(e){var r=this;if(!e||!this._heartbeatConfig.looping)return this._clearPlayer(),new Promise(function(t){r._player=r.animate({symbol:r._heartbeatConfig.originStyle},{duration:r._heartbeatConfig.duration},function(e){"finished"===e.state.playState&&(r._heartbeatConfig.looping||r.setZIndex(r._heartbeatConfig.originZindx),t(!0))})});this.playLoop()});return function(e){return t.apply(this,arguments)}}(),t.remove=function(){var e;return this.stopLoop(),null!=(e=this._player)&&e.finish(),this._clearPlayer(),this.off("mouseenter",this._onMouseenter),this.off("mouseout",this._onMouseout),null!=this&&null!=(e=this._clearAllListeners)&&e.call(this),r.prototype.remove.call(this),this},t._clearPlayer=function(){var e;null!=(e=this._player)&&e.pause(),this._animPlayer=void 0},t.stopLoop=function(){return this._heartbeatConfig.looping=!1,this},e}(LineString);function main(e){setBaseUrl(e)}HeartbeatLineString.registerJSONType("HeartbeatLineString");export{BorderLayer,CityBoundry,HeartbeatLineString,OffsetLayer,main as default};
