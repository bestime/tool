/**  
 * 浏览器工具库 => jUtilsBrowser
 * @update 2024-07-13 22:49:00
 */
import{defaultValue,isString,variableHasValue,isArray,forEach,_KvPair,_Number,cloneEasy,isNull}from"@bestime/utils_base";function getWindowSize(){return{width:document.documentElement.clientWidth||document.body.clientWidth||window.innerWidth||0,height:document.documentElement.clientHeight||document.body.clientHeight||window.innerHeight||0}}let htivId=0,idName="",isStart=!1;const records={};let timer;function stop(){isStart=!1,clearInterval(timer),timer=undefined}function startRun(){clearInterval(timer),isStart=!0,timer=setInterval(function(){for(var e in records){const t=records[e];t.current=+new Date,t.current-t.start>=t.interval&&(t.start=t.current,records[e].handler())}},17)}function add(e,t){return idName="HI-"+ ++htivId,records[idName]={start:+new Date,current:0,handler:e,interval:t},isStart||startRun(),idName}function remove(e){delete records[e],0===Object.keys(records).length&&stop()}var hpInterval={add:add,remove:remove};function observeDomResize(n,o,r,e){let l=[0,0,!1],i=[0,0,!1],c=[0,0,!1],a=[0,0,!1];const t=hpInterval.add(u,e=e||500);function u(){if(document.body.contains(n)){let e=!1;var t;r?.includes("position")&&(t=n.getBoundingClientRect(),c[0]=t.left,c[2]=c[0]!==c[1],a[0]=t.top,a[2]=a[0]!==a[1]),l[0]=n.offsetWidth,l[2]=l[0]!==l[1],i[0]=n.offsetHeight,i[2]=i[0]!==i[1],l[2]&&(l[1]=l[0],r?.includes("width")&&(e=!0)),i[2]&&(i[1]=i[0],r?.includes("height")&&(e=!0)),(a[2]||c[2])&&(a[1]=a[0],c[1]=c[0],r?.includes("position")&&(e=!0)),r&&0!==r.length||(l[2]||i[2]||a[2]||c[2])&&(e=!0),e&&o(n)}else s()}function s(){hpInterval.remove(t),l=undefined,i=undefined}return u(),s}function downloadFileByUrl(e,t){const n=document.createElement("a");n.style.display="none",n.download=t,n.setAttribute("href",e),n.setAttribute("target","_blank"),n.setAttribute("download",t),document.body.appendChild(n),n.click(),n.remove()}const $undefinedValue=void 0,$decodeURIComponent=decodeURIComponent,$browserGlobal=window,$headElement=document.getElementsByTagName("head")[0];function downloadFileByArrayBuffer(e,t){const n=$browserGlobal.URL;e=n.createObjectURL(new Blob([e]));downloadFileByUrl(e,t),n.revokeObjectURL(e),undefined}function removeElement(e){e.parentNode&&e.parentNode.removeChild(e)}function prevent(e,t,n){e=e||$browserGlobal.event,n=!1!==n,(t=!1!==t)&&$browserGlobal.event?$browserGlobal.event.cancelBubble=!0:e.stopPropagation(),n&&$browserGlobal.event?$browserGlobal.event.returnValue=!1:e.preventDefault()}function getStorage(e){e=localStorage.getItem(e);return defaultValue(e,"")}function removeStorage(e){localStorage.removeItem(e)}function hpSetStringValue(e){return e=isString(e)?e:JSON.stringify(e)}function setStorage(e,t){localStorage.setItem(e,hpSetStringValue(t))}function getRelativePos(e){var t=e.getBoundingClientRect();return{x:t.left,y:t.top,height:e.offsetHeight,width:e.offsetWidth,clientWidth:e.clientWidth,clientHeight:e.clientHeight}}function getJsFileBaseUrl(e){e=e||0;for(var t="/[^/]*",n=document.scripts,o=0;o<e;o++)t+=t;return n[n.length-1].src.replace(new RegExp(t+"$"),"")}function hpCreateFileLoaderElement(t,n,o,r){if($headElement){let e;if("js"===t?(e=document.createElement("script")).src=n:((e=document.createElement("link")).setAttribute("rel","stylesheet"),e.href=n),r)for(var l in r)e.setAttribute(l,r[l]);e.onload=e.onerror=o,$headElement.appendChild(e)}}const cache={};function loadMultiple(n,o){const r=[];let l=0;for(let t=0;t<n.length;t++)loadSingle(n[t],function(e){r[t]=e,++l===n.length&&o.apply($undefinedValue,r)})}function loadSingle(e,t){var n=e.dependencies&&e.dependencies.length,o=e["with"]&&e["with"].length;cache[e.url]||(cache[e.url]={count:0,dependencies:!n,"with":!o,complete:!1,create:!1,url:e.url});const r=cache[e.url];function l(){return $browserGlobal[e.module]}function i(){r.complete&&r.dependencies&&r["with"]&&(e.module?t(l()):t())}r.count++,!r.dependencies&&n?(r.dependencies=!0,loadMultiple(e.dependencies,function(){loadSingle(e,t)})):!r["with"]&&o?(r["with"]=!0,loadMultiple(e["with"].concat(e),i)):r.create?variableHasValue(function(){return r.complete},i,300):(r.create=!0,hpCreateFileLoaderElement(e.type,e.url,function(){r.complete=!0,e.interceptor&&e.interceptor(l()),i()},e.attribute))}function libraryFile(e,t){(e instanceof Array?loadMultiple:loadSingle)(e,t)}function setObjectToString(e){return e=isString(e)?e:JSON.stringify(e)}function setCookie(e,t,n){t=setObjectToString(t);let o=e+"="+encodeURI(t)+";path=/;";"number"==typeof n&&((e=new Date).setTime(e.getTime()+n),o+="expires="+e.toUTCString()),document.cookie=o}function getCookie(e,t){t=t||document.cookie;let o="";return t.replace(new RegExp("(^|;\\s?)"+e+"=(.*?)($|(;\\s?))"),function(e,t,n){o=$decodeURIComponent(n)}),o}function removeCookie(e){setCookie(e,"",-1)}function removeClass(t,e){isArray(e)?forEach(e,function(e){t.classList.remove(e)}):t.classList.remove(e)}function addClass(t,e){isArray(e)?forEach(e,function(e){t.classList.add(e)}):t.classList.add(e)}function replaceClass(e,t,n){removeClass(e,t),addClass(e,n)}function toggleClass(t,e){isArray(e)?forEach(e,function(e){t.classList.toggle(e)}):t.classList.toggle(e)}const agent=$browserGlobal.navigator.userAgent;var browser={isChrome:/Chrome/.test(agent),isIPhone:/iPhone/.test(agent)};function getRatio(){return window.devicePixelRatio||1}function observeMouseWheel(e,n,o){function t(e){let t;if(t=e.wheelDelta?0<e.wheelDelta?1:-1:e.detail<0?1:-1,n(t),o)return e.preventDefault&&e.preventDefault(),!1}return e.addEventListener("mousewheel",t),e.addEventListener("DOMMouseScroll",t),{dispose:function(){e.removeEventListener("mousewheel",t),e.removeEventListener("DOMMouseScroll",t)}}}function observeDomScroll(n,e){const o=_KvPair(e),r=_Number(o.offetY);let l=!1,i=0;function t(){if(l)return console.log("滚动中",l);var e=n.scrollTop,t=e-i;i=e,0!=t?t<0&&o.onTop&&e<=0+r?(l=!0,o.onTop(function(){l=!1})):0<t&&o.onBottom&&e>=n.scrollHeight-n.offsetHeight-r?(l=!0,o.onBottom(function(){l=!1})):l=!1:(l=!1,console.log("未处理"))}return n.addEventListener("scroll",t),{dispose:function(){n.removeEventListener("scroll",t)}}}const defaultCallback=e=>{};function open(e,t){const n=t||defaultCallback;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullScreen?e.webkitRequestFullScreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen(),n(!0)}function close(e){const t=e||defaultCallback,n=document;document.exitFullscreen?document.exitFullscreen().then(function(){t(!0)})["catch"](function(){t(!1)}):n.webkitCancelFullScreen?(n.webkitCancelFullScreen(),t(!0)):n.mozCancelFullScreen?(n.mozCancelFullScreen(),t(!0)):n.msExitFullscreen&&(n.msExitFullscreen(),t(!0))}function fullScreen(e,t,n){t?open(e,n):close(n)}function getTreeDepth(t,n){n=isNull(n)?1:n;for(let e=0;e<t.length;e++){var o=t[e];isNull(o.children)||(o=getTreeDepth(o.children,n+1),n=Math.max(n,o))}return n}function getColSpan(e,t,n){if(!isNull(e.colSpan))return e.colSpan;if(!e.children||e.children.length<=1)return 1;e=n-t;return 0==e?e:1+e}async function createXLSX(n){const e=cloneEasy(n.header),o=document.createElement("table"),r=getTreeDepth(n.header);function l(i,c){const a=[];return function u(t,n,o){for(let e=0;e<n.length;e++){var r,l=n[e].children;if(t===i){let e=o;n.forEach(function(t){var n=e,o=e=function i(t,e){return e&&(t+=e.length-1,e.forEach(function(e){t=i(t,e.children)})),t}(e,t.children);e++;for(let e=0;e<=o-n;e++){var r=e+n,l=0===e?o:r;a[r]={title:t.title,field:t.field,colStart:r,colEnd:l,colSpan:getColSpan(t,r,l)}}})}else l&&t<i&&(r=c?.[e+o]?.colStart??0,u(t+1,l,r))}}(1,e,0),a}const i=[];!function u(e,t){e<=r&&(t=l(e,t),i.push(t),u(e+1,t))}(1),i.forEach(function(e,n){e.forEach(function(e,t){e&&(e.rowSpan=function(e,t){let n=0;for(;e<i.length&&!i?.[e]?.[t];e++)n++;return n}(n+1,t)+1)})});var t=i.map(function(e){return`<tr>${e.map(function(e){if(e&&0!==e.colSpan)return`<td rowSpan="${e.rowSpan}" colSpan="${e.colSpan}">${e?.title}</td>`}).join("")}</tr>`}).join("");const c=function(){const n=[];for(let e=i.length-1;0<=e;e--)i[e].forEach(function(e,t){e&&e.field&&isNull(n[t])&&(n[t]=e.field)});return n}();var a=n.body.map(function(o){return`<tr>${c.map(function(e){var t=o.$colField?.[e]??1,n=o.$rowSpan?.[e]??1;if(0!==t&&0!==n)return`<td colSpan="${t}" rowSpan="${n}">${o[e]}</td>`}).filter(function(e){return!isNull(e)}).join("")}</tr>`}).join("");return o.innerHTML=`<thead>${t}</thead><tbody>${a}</tbody>`,o.setAttribute("border","1"),libraryFile({type:"js",url:n.pluginUrl,module:"XLSX",attribute:{type:"module"}},function(e){console.log("headFeilds",i,c,n.body);var t=e.utils.table_to_book(o);e.writeFile(t,"Report.xlsx")}),o}export{addClass,browser,createXLSX,downloadFileByArrayBuffer,downloadFileByUrl,fullScreen,getCookie,getJsFileBaseUrl,getRatio,getRelativePos,getStorage,getWindowSize,libraryFile,observeDomResize,observeDomScroll,observeMouseWheel,prevent,removeClass,removeCookie,removeElement,removeStorage,replaceClass,setCookie,setStorage,toggleClass};
