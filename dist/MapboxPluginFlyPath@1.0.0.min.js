/**
 * mapbox路径运动 MapboxPluginFlyPath@1.0.0.min.js
 * 
 * @QQ 1174295440
 * @author Jiang Yang (Bestime)
 * @see https://github.com/bestime/mapbox-plugin
 * @update 
 */

var MapboxPluginFlyPath=function(){var e=Object.prototype.toString,s="Object",c="String";function h(t){return e.call(t).slice(8,-1)}function p(t){return h(t)===s}function r(e){var t,i,o=1,n=h(e),r=arguments,a=r.length;if(n===s){for(;o<a;o++)if(p(i=r[o]))for(t in i)e[t]=i[t]}else if(e.length)for(;o<a;o++)!function(t,e,i,o){var n=0;if("json"===i){for(var r in t)if(!0===e(t[r],r,n++,t))break}else if(!0===o)for(n=t.length-1;0<=n&&!0!==e(t[n],n,t);n--);else for(var a=t.length;n<a&&!0!==e(t[n],n,t);n++);}(r[o],function(t){n===c?e+=t:e.push(t)});return e}function u(t,e,i,o){var n=1-o;return n*n*t+2*(1-o)*o*e+o*o*i}function t(t,e){try{t.getLayer(e)&&t.removeLayer(e)}catch(i){}}function i(t,e){try{t.getSource(e)&&t.removeSource(e)}catch(i){}}var _,a="Bestime.MapboxPluginFlyPath";function o(t,i,e,o){var n;if(p(o)?o.iconPath||(n="必须传入图片"):n="配置项格式错误",n)throw Error(a+"警告："+n);_=e,this.options=r({step:500,curveness:1,lineColor:"rgba(0,0,0,0.6)",lineWidth:4,iconScale:1,lineDashArray:[1,0],iconPath:""},o),i.loadImage(this.options.iconPath,(t,e)=>{e&&(i.addImage(this.options.iconPath,e),this._iconReady=!0)}),this._source_id_point=a+"-source-point-"+t,this._layer_id_pint=a+"-layer-point-"+t,this._layer_id_path=a+"-layer-path-"+t,this._source_id_path=a+"-source-path-"+t,this.map=i,this._timer=null,this._isMounted=!0,this._distance=0,this._lineCache={type:"FeatureCollection",features:[{type:"Feature",properties:{color:"blue"},geometry:{type:"LineString",coordinates:[]}}]},i.addSource(this._source_id_path,{type:"geojson",data:{type:"FeatureCollection",features:[]}}),i.addLayer({id:this._layer_id_path,source:this._source_id_path,type:"line",paint:{"line-width":this.options.lineWidth,"line-color":this.options.lineColor,"line-dasharray":this.options.lineDashArray}}),i.addSource(this._source_id_point,{type:"geojson",data:{type:"FeatureCollection",features:[]}}),i.addLayer({id:this._layer_id_pint,source:this._source_id_point,type:"symbol",layout:{"icon-size":this.options.iconScale,"icon-image":this.options.iconPath,"icon-rotate":["get","bearing"],"icon-rotation-alignment":"map","icon-allow-overlap":!0,"icon-ignore-placement":!0}})}return o.prototype._addLlinePoint=function(t){this._lineCache.features[0].geometry.coordinates.push(t),this.map.getSource(this._source_id_path).setData(this._lineCache)},o.prototype._twoPoint=function(n,r,a,s){var c={type:"Feature",geometry:{type:"LineString",coordinates:[r,a]}},h=_.lineDistance(c,{units:"meters"});clearInterval(this._timer);var p=0,l=r;this._timer=setInterval(()=>{var t,e,i=_.along(c,p,{units:"meters"}).geometry.coordinates;0===p?i=r:h<=p?(p=h,clearInterval(this._timer),i=a):0!==this.options.curveness&&(t=this.options.curveness,e=p/h,t=[(r[0]+a[0])/2-(r[1]-a[1])*t,(r[1]+a[1])/2-(a[0]-r[0])*t],i=[u(r[0],t[0],a[0],e),u(r[1],t[1],a[1],e)]),!n&&0===p&&0!==h||(o=_.bearing(_.point(l),_.point(i)),this._addLlinePoint(i),this.map.getSource(this._source_id_point).setData({type:"FeatureCollection",features:[{type:"Feature",properties:{bearing:o},geometry:{type:"Point",coordinates:i}}]})),l=i;var o=p/h;isNaN(o)&&(o=1),s(i,o),p+=this.options.step},17)},o.prototype.clear=function(){clearInterval(this._timer),this._lineCache.features[0].geometry.coordinates=[],this.map.getSource(this._source_id_path).setData(this._lineCache),this.map.getSource(this._source_id_point).setData({type:"FeatureCollection",features:[]})},o.prototype.dispose=function(){clearInterval(this._timer),this.clear(),this._isMounted=!1,t(this.map,this._layer_id_path),t(this.map,this._layer_id_pint),i(this.map,this._source_id_point),i(this.map,this._source_id_path),function(t,e){try{t.hasImage(e)&&t.removeImage(e)}catch(i){}}(this.map,this.options.iconPath)},o.prototype.play=function(n,r){var e=this,a=-1;this.clear(),function s(e,i){var o;return i=null==i?60:i,new Promise(async function(t){e()?t():(clearTimeout(o),0<i?o=setTimeout(function(){t(s(e,i))},i):t(s(e,i)))})}(function(){return!!e._iconReady&&(function o(t){t<n.length-1&&e._isMounted&&(a=t+1,e._twoPoint(0===t,n[t],n[a],function(t,e){var i=1===e&&a===n.length-1;r&&r(t,e,i),1===e&&o(a)}))}(0),!0)})},o}();
