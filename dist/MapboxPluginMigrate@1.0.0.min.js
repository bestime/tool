/**
 * mapbox插件，类似迁徙图 MapboxPluginMigrate@1.0.0.min.js
 * 
 * @QQ 1174295440
 * @author Jiang Yang (Bestime)
 * @see https://github.com/bestime/mapbox-plugin
 * @update 2022-04-11 10:57:07
 */

var MapboxPluginMigrate=function(){function a(t,e,r,o){r=[(t[0]+e[0])/2-(t[1]-e[1])*r,(t[1]+e[1])/2-(e[0]-t[0])*r];return[i(t[0],r[0],e[0],o),i(t[1],r[1],e[1],o)]}function i(t,e,r,o){var i=1-o;return i*i*t+2*(1-o)*o*e+o*o*r}function t(t,e){try{t.getLayer(e)&&t.removeLayer(e)}catch(r){}}function e(t,e){try{t.hasImage(e)&&t.removeImage(e)}catch(r){}}function r(t,e){try{t.getSource(e)&&t.removeSource(e)}catch(r){}}var n,o="MapboxPluginMigrate";function s(t,e,r){n=r,this.records=[],this.timer=null,this.map=e,this.LAYER_ID_POINT=o+"layer-point"+t,this.LAYER_ID_PATH=o+"layer-path"+t,this.LAYER_ID_SHAN_ICON=o+"layer-shan"+t,this.SOURCE_ID_POINT=o+"source-point"+t,this.SOURCE_ID_PATH=o+"source-path"+t,this.SOURCE_ID_SHAN_ICON=o+"source-shan"+t,e.addSource(this.SOURCE_ID_SHAN_ICON,{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.addLayer({id:this.LAYER_ID_SHAN_ICON,type:"symbol",source:this.SOURCE_ID_SHAN_ICON,layout:{"icon-image":["get","targetIcon"],"icon-rotation-alignment":"map","icon-allow-overlap":!0,"icon-ignore-placement":!0}}),e.addSource(this.SOURCE_ID_PATH,{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.addLayer({id:this.LAYER_ID_PATH,source:this.SOURCE_ID_PATH,type:"line",paint:{"line-width":2,"line-color":["get","color"],"line-dasharray":[4,2]}}),e.addSource(this.SOURCE_ID_POINT,{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.addLayer({id:this.LAYER_ID_POINT,source:this.SOURCE_ID_POINT,type:"symbol",layout:{"icon-size":1,"icon-image":["get","flyIconId"],"icon-rotate":["get","bearing"],"icon-rotation-alignment":"map","icon-allow-overlap":!0,"icon-ignore-placement":!0}}),this.startPlay()}return s.prototype.getAllIconPoint=function(){return{type:"FeatureCollection",features:this.records.map(function(t){return{type:"Feature",properties:{targetIcon:t.targetIcon},geometry:{type:"Point",coordinates:t.data.path[1].coordinate}}})}},s.prototype.getAllLinesFeature=function(){return{type:"FeatureCollection",features:this.records.map(function(t){return{type:"Feature",properties:{color:t.data.color},geometry:{type:"LineString",coordinates:t.lines}}})}},s.prototype.getAllFlyFeature=function(){return{type:"FeatureCollection",features:this.records.map(function(t){return{type:"Feature",properties:{flyIconId:t.flyIconId,bearing:t.bearing},geometry:{type:"Point",coordinates:t.coordinates}}})}},s.prototype.dispose=function(){clearInterval(this.timer),t(this.map,this.LAYER_ID_POINT),t(this.map,this.LAYER_ID_PATH),t(this.map,this.LAYER_ID_SHAN_ICON),r(this.map,this.SOURCE_ID_POINT),r(this.map,this.SOURCE_ID_PATH),r(this.map,this.SOURCE_ID_SHAN_ICON),this.records.forEach(t=>{e(this.map,t.targetIcon),e(this.map,t.flyIconId)}),this.records=undefined},s.prototype.startPlay=function(){clearInterval(this.timer),this.timer=setInterval(()=>{this.records.forEach(t=>{var e,r,o;t["delete"]||(e=t.data.path[0].coordinate,o=t.data.path[1].coordinate,t.percent+=t.direction*t.speed,1<t.percent?(t.direction=-1,t.percent=1,t.count++):t.percent<=0&&(t.percent=0,t.direction=1),r=t.coordinates,o=a(e,o,t.curveness,t.percent),t.coordinates=o,t.bearing=n.bearing(n.point(r),n.point(o)),this._updateFlyIcon())})},17)},s.prototype._updatePathAndTarget=function(){this.map.getSource(this.SOURCE_ID_PATH).setData(this.getAllLinesFeature()),this.map.getSource(this.SOURCE_ID_SHAN_ICON).setData(this.getAllIconPoint())},s.prototype._updateFlyIcon=function(){this.map.getSource(this.SOURCE_ID_POINT).setData(this.getAllFlyFeature())},s.prototype.removeById=function(t){for(var e=0;e<this.records.length;e++)this.records[e].id===t&&this.records.splice(e--,1);this._updateFlyIcon(),this._updatePathAndTarget()},s.prototype.add=function(e){!function(t,e){for(var r=!1,o=t.length,i=0;i<o;i++)if(!0===e(t[i],i,t)){r=!0;break}return r}(this.records,function(t){return t.id===e.id})&&(this.records.push({id:e.id,"delete":!1,speed:e.speed,curveness:e.curveness,flyIconId:e.iconFly,targetIcon:e.iconTarget,direction:1,percent:0,data:e,bearing:0,count:0,lines:function(t,e,r){for(var o,i=[t],n=0;n<1;n+=.01)o=a(t,e,r,n),i.push(o);return i.push(e),i}(e.path[0].coordinate,e.path[1].coordinate,e.curveness),coordinates:e.path[0].coordinate}),this._updatePathAndTarget())},s}();
