<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>测试页面3333</title>
  <script src="./dist/bestime@beta.min.js"></script>
  <style>
    
  </style>
</head>
<body>



  <div id="time-demo"></div>



<script>
// timingPlan('seconds', true, function (time) {
//   console.log('整秒计划执行了', time)
// })

// timingPlan('minute', true, function (time) {
//   console.log('%c整分计划执行了', 'background:blue;color:#fff;', time)
// })

// timingPlan('hour', true, function (time) {
//   console.log('%c整点计划执行了', 'background:green;color:#fff;', time)
// })

// timingPlan(['12:00:00', '12:10:00'], true, function (time) {
//   console.log('%c定时计划执行了', 'background:green;color:#fff;', time)
// })

/*

*/


/**
 * 定时计划 
 * @param {String} target 计划方式。支持：seconds，minute，hour
 * @param {Boolean} [immediate=false] 是否立即执行一次
 * @param {Function} callback 计划触发回调
*/
function timingPlan (target, immediate, callback) {
  var date, hour, minute, seconds, milliSecond;
  immediate = immediate === true
  var duration;
  var timer;
  var adj = 18
  var appointedList;
  
  var oneSecond = 1000
  var oneMinute = oneSecond * 60
  var oneHour = oneMinute * 60
  var oneDay = onHour * 24

  function getType (data) {
    return Object.prototype.toString.call(data).slice(8, -1)
  }
  

  function doOnce () {
    immediate = false;
    readyNextWork()
    callback(hour + '时' + minute + '分' + seconds + '秒' + milliSecond + '毫秒')
  }


  readyNextWork()
  function readyNextWork () {
    date = new Date()
    hour = date.getHours()
    minute = date.getMinutes()
    seconds = date.getSeconds()
    milliSecond = date.getMilliseconds()
    clearTimeout(timer)
    if(immediate) {
      doOnce()
    } else {
      switch (target) {
        case 'seconds':
          duration = Math.max(1000 - milliSecond, adj)
          break;
        case 'minute':
          duration = 1000*(60 - seconds) - milliSecond
          break;
        case 'hour':
          duration = 60000*(60-minute) - 1000 * seconds - milliSecond
          break;
        // default:
        //   appointedList = appointedList || []
        //   if(getType(target) === 'Array') {
        //     for(var a = 0; a< target.length; a++) {
        //       target = target.split(':')
        //       target[0] = target[0] * oneHour
        //       target[1] = target[1] * oneMinute
        //       target[2] = target[2] * oneSecond
        //       var a = hour*oneHour + minute*oneMinute + seconds * oneSecond - target[0] - target[1]-target[2]
        //       a = a > 0 ? a : a+oneDay
        //       appointedList.push(a)
        //     }
        //   }
      }
      timer = setTimeout(doOnce, duration);
    }
  }
}

































function AutoPager () {

}

AutoPager.prototype.dispose = function () {
  clearTimeout(this.timer)
  this.list = null
  this.useList = null
  this.pageStep = null
  this.callback = null
  this.pageSize = null
  this.interval = null
  this.currentIndex = null
}


AutoPager.prototype.next = function () {
  let res = [];
  let startIndex = this.currentIndex
  let endIndex = this.currentIndex + this.pageSize
  let diff = endIndex - this.list.length
  const indexList = []

  if(diff > 0) {
    endIndex = this.list.length
    indexList.push({
      start: 0,
      end: diff
    })
  }
  indexList.unshift({
    start: startIndex,
    end: endIndex
  })

  indexList.forEach(({start, end}) => {
    res = res.concat(this.list.slice(start, end))
  })

  if(indexList.length >1 && !this.loop) return console.log('完毕了')

  this.list && this.callback(res, () => {
    clearTimeout(this.timer)
    this.timer = setTimeout(() => {
      let nextIndex = this.currentIndex + this.pageStep
      if(nextIndex >= this.list.length) {
        nextIndex -= this.list.length
      }
      this.currentIndex = nextIndex
      this.next()
    }, this.interval)
  }, indexList)
}

AutoPager.prototype.start = function (loop, pageStep, pageSize, list, interval, callback) {
  this.list = list
  this.loop = loop
  this.interval = interval
  this.pageStep = pageStep
  this.pageSize = pageSize
  this.currentIndex = 0
  this.callback = callback

  if(this.pageSize < list.length) {
    this.next()
  } else {
    console.warn('pageSize大于或等于list的值，不需要分页')
  }
}



// 0-14
// 1-15


// 初始化自动分页
const autoPager = new AutoPager()
const list = [1, 2, 3, 4, 5, 6,7,8,9,10,11,12,13,14,15]
const list2 = list.map(c => '_' + c)
// 销毁实例
autoPager.dispose() 
// 开始自动分页
// autoPager.start(false, 2, 10, list, 1000, function (list, next, indexList) {
//   console.log('一次分页', list, JSON.stringify(indexList))
//   next()
// })


const convertTime = ns.convertTime
const formatTime = ns.formatTime

function formatShortTime (time, accuracy) {
  const currentDate = new Date()
  const compareTime = new Date(time)
  let fmt;
  const now = convertTime(currentDate)
  const compare = convertTime(compareTime)
  const timeMillisecond = compareTime.getTime()
  
  if(timeMillisecond > currentDate.getTime()){ // 未来时间
    if(new Date(compare.year) > new Date(now.year)) {
      fmt = 'YYYY年MM月DD日HH:mm:ss'
    } else if(new Date(compare.year, compare.month-1) > new Date(now.year, now.month-1)) {
      fmt = 'MM月DD日HH:mm:ss'
    } else if(new Date(compare.year, compare.month-1, compare.day) > new Date(now.year, now.month-1, now.day)) {
      fmt = 'DD日HH:mm:ss'
    } else {
      fmt = 'HH:mm:ss'  
    }
  } else { //过去时间
    if(timeMillisecond > +new Date(now.year, now.month-1, now.day, now.hour)) {
      fmt = 'HH:mm:ss'
    } else if(timeMillisecond > +new Date(now.year, now.month-1, now.day)) {
      fmt = 'HH:mm:ss'
    }else if(timeMillisecond > +new Date(now.year, now.month-1)) {
      fmt = 'DD日HH:mm:ss'
    }else if(timeMillisecond > +new Date(now.year,1,1)) {
      fmt = 'MM月DD日HH:mm:ss'
    } else {
      fmt = 'YYYY年MM月DD日HH:mm:ss'
    }
  }


  // 调整格式化精度
  if(accuracy==='day') {
    fmt = fmt.replace(/(HH)(:mm)|(:ss)/g, '')
  } else if(accuracy==='hour') {
    fmt = fmt.replace(/(:mm)|(:ss)/g, '')
    fmt += '时'
  } else if(accuracy==='minute') {
    fmt = fmt.replace(/(:ss)/g, '')
  }

  const res = formatTime(fmt, time)
  console.log(time, '=>', fmt, '=>', res)
  return res;
}




// ;[
//   '2022-08-20 23:59:59',
//   '2021-08-20 23:59:59',
//   '2021-07-20 23:59:59',
//   '2021-07-19 23:59:59',
//   '2021-07-19 06:00:48',
//   '2021-07-18 06:25:26',
//   '2021-07-17 06:00:00',
//   '2021-06-15 06:00:05',
//   '2020-06-15 06:00:00',
// ].forEach(function (item) {
//   formatShortTime(item, 'minute')
// })

const arr = [
  {
    id: 'a',
    children: [
      {
        id: 'b',
        children:[
          {
            name: 'bestime'
          },
          {
            id: 'ef'
          }
        ]
      }
    ]
  },
  {
    id: 'c',
    children: [
      {
        id: 'f'
      }
    ]
  }
]




var dd = ns.deepFindItem(arr, function (c){
  return c.id == null
})
console.log('dd', dd)




const timeList = [
  '2019-08-20 13:20:00',
  '2019-08-20 13:20:10',
  '2019-08-20 13:20:20',
  '2019-08-25 14:36:20',
  '2019-09-25 14:36:20',

  '2021-10-27 00:20:00',
  '2021-10-27 00:30:00',
  '2021-10-27 00:40:00',
]




var unique = ns.unique
function parseTimeList (list) {
  var timeTree = {}
  var _yearKey, _monthKey;
  var _dayKey
  var _hourKey
  var _minuteKey
  var _secondKey
  var _milliSecondKey
  var _timestamp;
  
  list.forEach(function (time) {
    var item = convertTime(new Date(time))
    _timestamp = new Date(time).getTime()
    // console.log('_timestamp', _timestamp)
    _yearKey = item.year+ '年'
    _monthKey = item.month+ '月'
    _dayKey = item.day+ '日'
    _hourKey = item.hour+ '时'
    _minuteKey = item.minute+ '分'
    _secondKey = item.second + '秒'
    _milliSecondKey = item.milliSecond + '毫秒'

    // console.log(_yearKey, _monthKey, _dayKey, _hourKey, _minuteKey,_secondKey,_milliSecondKey)
    
    timeTree[_yearKey] = timeTree[_yearKey] || {
      // prefix: '',
      value: _yearKey,
      label: time,
      timestamp: _timestamp,
      sub: {}
      
    }

    timeTree[_yearKey].sub[_monthKey] = timeTree[_yearKey].sub[_monthKey] || {
      // prefix: _yearKey,
      value: _monthKey,
      label: time,
      timestamp: _timestamp,
      sub: {}
    }

    timeTree[_yearKey].sub[_monthKey].sub[_dayKey] = timeTree[_yearKey].sub[_monthKey].sub[_dayKey] || {
      // prefix: _yearKey+_monthKey,
      value: _dayKey,
      label: time,
      timestamp: _timestamp,
      sub: {}
    }

    timeTree[_yearKey].sub[_monthKey].sub[_dayKey].sub[_hourKey] = timeTree[_yearKey].sub[_monthKey].sub[_dayKey].sub[_hourKey] || {
      // prefix: _yearKey+_monthKey+_dayKey,
      value: _hourKey,
      label: time,
      timestamp: _timestamp,
      sub: {}
    }

    timeTree[_yearKey].sub[_monthKey].sub[_dayKey].sub[_hourKey].sub[_minuteKey] = timeTree[_yearKey].sub[_monthKey].sub[_dayKey].sub[_hourKey].sub[_minuteKey] || {
      // prefix: _yearKey+_monthKey+_dayKey+_hourKey,
      value: _minuteKey,
      label: time,
      timestamp: _timestamp,
      sub: {}
    }

    timeTree[_yearKey].sub[_monthKey].sub[_dayKey].sub[_hourKey].sub[_minuteKey].sub[_secondKey] = timeTree[_yearKey].sub[_monthKey].sub[_dayKey].sub[_hourKey].sub[_minuteKey].sub[_secondKey] || {
      // prefix: _yearKey+_monthKey+_dayKey+_hourKey+_minuteKey,
      value: _secondKey,
      label: time,
      timestamp: _timestamp,
      sub: {}
    }

    timeTree[_yearKey].sub[_monthKey].sub[_dayKey].sub[_hourKey].sub[_minuteKey].sub[_secondKey].sub[_milliSecondKey] = timeTree[_yearKey].sub[_monthKey].sub[_dayKey].sub[_hourKey].sub[_minuteKey].sub[_secondKey].sub[_milliSecondKey] || {
      // prefix: _yearKey+_monthKey+_dayKey+_hourKey+_minuteKey+_secondKey,
      value: _milliSecondKey,
      label: time,
      timestamp: _timestamp,
      sub: undefined
    }

    // console.log('item', item)
  })

  // 将json转为数组的方式
  let res = treeToArray(timeTree)

  // 移除重复节点，第一个节点上提
  arrayUpSingleChildren(res)
  
  

  // res.sort(function (a, b) {
  //   return a.timestamp - b.timestamp
  // })

  console.log(timeTree, res)

  return res
}




function treeToArray (tree) {
  
  

  function deep (tree) {
    for(var key in tree) {
      let item = tree[key]
      if(item.sub) {
        var children = toChildren(tree[key].sub)
        item.children = children
        deep(item.sub)
        delete item.sub
      }
    }
  }

  let res = [];
  deep(tree)
  for(let key in tree) {
    res.push(tree[key])
  }
  
  return res;
}


function parseTree (tree, total) {
  var item;
  for(var key in tree) {
    item = tree[key]
    total.push(tree[key])
    if(tree[key].sub) {
      var children = toChildren(tree[key].sub)
      if(children.length) {
        tree[key].root = children.splice(0, 1)[0]
        if(children.length) {
          tree[key].children = children
        }
      }
      parseTree(tree[key].sub, total)
      delete tree[key].sub
    }
  }
}


function toChildren (sub) {
  var res = []
  for(let key in sub) {
    res.push(sub[key])
  }
  // res.sort(function (a,b) {
  //   return a.timestamp - b.timestamp
  // })
  return res;
}




// 将单节点提升一个层级
function arrayUpSingleChildren (list) {
  for(let a = 0; a < list.length; a++) {
    while (list[a].children && list[a].children.length === 1) {
      list[a] = list[a].children[0]
    }
    if(list[a].children && list[a].children.length > 1) {
      arrayUpSingleChildren(list[a].children)
    }
  }
}




const result = parseTimeList(timeList)
renderListToHtml(document.getElementById('time-demo'), result)
console.log('result', result)





function renderListToHtml (oWrapper, data) {
  const oUl = document.createElement('ul')
  data.forEach(item => {
    
    var oLi = document.createElement('li')
    oLi.innerHTML = `<div>${item.value}</div>`
    if(item.children) {
      renderListToHtml(oLi, item.children)
    }
    
    oUl.appendChild(oLi)
  })
  
  oWrapper.appendChild(oUl)
}

</script>
</body>
</html>
