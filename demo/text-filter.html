
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文本筛选</title>
  <script src="./js/text-data.js"></script>
  <!-- <script src="./js/filter-text.js"></script> -->
  <script src="./js/pinyin/pinyin_dict_withtone.js"></script>
  <script src="./js/pinyin/pinyinUtil.js"></script>
  <style>
    .find{
      color: red;
    }
  </style>
</head>
<body>
  <input value="可以走，可以跳" id="add-one" placeholder="添加词组"/>
  <button onclick="createData()">添加</button><br/>
  <input oninput="onInput(this)" placeholder="拼音搜索"/>
<script>

function isFunction (data) {
  return typeof data === 'function'
}

function forEach (data, handle, type, reverse) {
  if(!isFunction(handle)) return;
  var index = 0;
  switch (type) {
    case 'json': 
      for(var key in data) {
        if(handle(data[key], key, index++, data) === true){
          break;
        }
      }
      break;
    default:
      if(reverse === true) {
        for(index = data.length - 1; index >= 0; index--) {
          if(handle(data[index], index, data) === true){
            break;
          }
        }
      } else {
        for(var len = data.length; index < len; index++) {
          if(handle(data[index], index, data) === true){
            break;
          }
        }
      }
  }
}

  var oUl = document.createElement('ul')
  var _ulHtml = ''
  document.body.appendChild(oUl)
  var demoData = [
    {
      label: '陈小刚',
      spell: [
        { key: ['陈', 'chen'], value: '陈'},
        { key: ['小', 'xiao'], value: '小'},
        { key: ['刚', 'gang'], value: '刚'},
      ]
    },
    {
      label: '张三',
      spell: [
        { key: ['张', 'zhang'], value: '张'},
        { key: ['三', 'san'], value: '三'},
      ]
    },
    {
      label: '今天天气不错',
      spell: [
        { key: ['今', 'jin'], value: '今'},
        { key: ['天', 'tian'], value: '天'},
        { key: ['天', 'tian'], value: '天'},
        { key: ['气', 'qi'], value: '气'},
        { key: ['不', 'bu'], value: '不'},
        { key: ['错', 'cuo'], value: '错'},
      ]
    },
    {
      label: '蒋重阳',
      spell: [
        { key: ['蒋', 'jiang'], value: '蒋'},
        { key: ['重', 'chong','zhong'], value: '重'},
        { key: ['阳', 'yang'], value: '阳'},
      ]
    },
    {
      label: '天空很蓝',
      spell: [
        { key: ['天', 'tian'], value: '天'},
        { key: ['空', 'kong'], value: '空'},
        { key: ['很', 'hen'], value: '很'},
        { key: ['蓝', 'lan'], value: '蓝'}
      ]
    },
    {
      label: '你枪法好吗',
      spell: [
        { key: ['你', 'ni'], value: '你'},
        { key: ['枪', 'qiang'], value: '枪'},
        { key: ['法', 'fa'], value: '法'},
        { key: ['好', 'hao'], value: '好'},
        { key: ['吗', 'ma'], value: '吗'},
      ]
    }
  ]

  ;(function () {
    var str;
    var spell = []
    for(var a=0; a<testList.length; a++) {
      str = testList[a].ck_content
      spell = []
      for(var b=0;b<str.length;b++) {
        pyarr = pinyinUtil.getPinyin(str[b], null, false,true)
        spell.push({
          key: [str[b]].concat(pyarr),
          value: str[b]
        })
      }
      demoData.push({
        label: str,
        spell: spell
      })
    }
  })();

  // console.log('demoData', demoData)

  function createData () {
    var oInput = document.getElementById('add-one')
    var str = oInput.value
    if(!str) return;
    oInput.value = ''
    var pyarr;
    var spell = []
    for(var b=0; b< str.length;b++) {
      pyarr = pinyinUtil.getPinyin(str[b], null, false,true)
      spell.push({
        key: [str[b]].concat(pyarr),
        value: str[b]
      })
    }
    demoData.push({
      label: str,
      spell: spell
    })
    console.log('demoData', demoData)
    updateDom(demoData)
  }
  
  function updateDom (list) {
    // list.sort(function (a, b) {
    //   return (a.count / a.spell.length) > (b.count / b.spell.length) ? -1 : 1
    // })
    _ulHtml = '';
    var item, percent = '';
    for(var a = 0; a < list.length; a++) {
      if(a>20) break;
      item = list[a]
      label = ''
      // console.log('list', list)
      if(item.count) {
        percent = '('+ Math.round((item.count / item.spell.length) * 100) +'%)';
        forEach(item.spell, function (lb) {
          if(lb.checked) {
            label += '<span  class="find">'+ lb.value +'</span>'
          } else {
            label += lb.value
          }
        })
      } else {
        label = item.label
      }
      _ulHtml += '<li>'+ label + percent +'</li>';
    }
    oUl.innerHTML = _ulHtml;
  }

  updateDom(demoData)

  

  var worder;
  function loopSearch (list, text, callback) {
    if(worder) {
      worder.terminate()
    }
    worder = new Worker("./js/filter-text.js")


    var start = 0;
    var step = 3000
    
    
    function once (old) {
      if(start < list.length) {
        worder.postMessage({
          old: old || [],
          list: list.slice(start, step + start),
          text: text
        })
      }
      
    }

    once()
    worder.onmessage = function (ev) {
      start += step
      pass = ev.data
      updateDom(pass)
      once(ev.data)
    }
  }

  function onInput (self) {
    var list = [];
    loopSearch(demoData, self.value, function (sustainList) {
      list = list.concat(sustainList)
      updateDom(list)
    })
  }
</script>

</body>
</html>